<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de P&D (v2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }

        /* Barras de rolagem */
        #observations-feed-list, #post-it-list, #feedback-samples-list {
            overflow-y: auto;
        }
        #observations-feed-list, #post-it-list {
            max-height: 448px; /* 28rem */
        }
        #feedback-samples-list {
            max-height: 70vh;
        }
        
        /* Ocultar scrollbar mas manter rolagem */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Estilos para o feed de observações e respostas */
        .manager-reply, .seller-reply, .pd-note {
            margin-top: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem; /* rounded-md */
        }
        .manager-reply {
            background-color: #f3f4f6; /* bg-gray-100 */
            border-left: 3px solid #9ca3af; /* border-gray-400 */
        }
        .seller-reply {
            background-color: #f0f9ff; /* bg-blue-50 */
            border-left: 3px solid #60a5fa; /* border-blue-400 */
            margin-left: 1rem; /* Indent seller reply */
        }
         .pd-note {
            background-color: #fffbeb; /* bg-amber-50 */
            border-left: 3px solid #fcd34d; /* border-amber-300 */
            margin-left: 0.5rem;
        }

        /* Estilo para Amostra destacada no modal */
        .feedback-sample-item {
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .feedback-sample-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .feedback-sample-item.highlight {
            background-color: #fffbeb; /* bg-amber-50 */
        }

        /* Estilo Card de Login removido */
    </style>
</head>
<body class="text-gray-800">

    <!-- Tela de Login -->
    <div id="login-view" class="grid place-items-center min-h-screen p-4">
        <!-- Card principal -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 w-full max-w-md p-8">
            <!-- Cabeçalho do Login -->
            <div class="flex flex-col justify-center items-center gap-3 mb-6">
                <!-- Ícone Lupa -->
                <div class="p-3 bg-indigo-100 rounded-full">
                    <svg class="w-8 h-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                       <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 text-center">Painel de P&D (v2)</h1>
            </div>
            <p class="text-gray-600 text-center mb-8">Por favor, selecione sua área e digite a senha.</p>
            
            <!-- NOVO FORMULÁRIO DE LOGIN -->
            <div class="space-y-4">
                <div>
                    <label for="pd-segment-select" class="block text-sm font-medium text-gray-700 mb-1">Área / Segmento</label>
                    <select id="pd-segment-select" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="">Selecione...</option>
                        <!-- Opções serão populadas pelo JS -->
                    </select>
                </div>
                
                <div>
                    <label for="pd-password-input" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input type="password" id="pd-password-input" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="Digite a sua senha...">
                </div>
            </div>
            
            <!-- Botão e Erro -->
            <div class="mt-8">
                <button id="pd-login-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors">Entrar</button>
                <p id="login-error" class="text-red-500 text-sm mt-3 h-4 text-center"></p>
            </div>
        </div>
    </div>


    <!-- Tela Principal (Dashboard) -->
    <div id="dashboard" class="hidden container mx-auto p-4 md:p-8">
        
        <header class="flex flex-col md:flex-row justify-between md:items-center mb-8 gap-4">
            <h1 id="dashboard-title" class="text-3xl font-bold text-gray-900">Dashboard</h1>
            <div class="flex items-center gap-4">
                <input id="global-search-input" type="text" placeholder="Pesquisar em todas as amostras..." class="border-gray-300 rounded-lg shadow-sm text-sm p-2 w-full md:w-64">
                <!-- Sino de Notificação (será adicionado aqui) -->
                <button id="logout-btn" class="bg-red-500 text-white font-semibold py-2 px-5 rounded-lg text-sm hover:bg-red-600">Sair</button>
            </div>
        </header>

        <!-- Estado de Carregamento -->
        <div id="loading-state" class="hidden text-center p-12">
            <h2 class="text-2xl font-semibold text-gray-700">A carregar dados...</h2>
            <p id="loading-message" class="text-gray-500 mt-2">A processar amostras. Isto pode demorar um momento...</p>
        </div>

        <!-- Conteúdo do Dashboard -->
        <div id="dashboard-content" class="hidden">
            <!-- Gráficos -->
            <section class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border">
                    <h3 class="font-bold text-lg mb-2 text-center">Status (Amostras do Segmento)</h3>
                    <div style="height: 250px;"><canvas id="segment-status-chart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border">
                    <h3 class="font-bold text-lg mb-2 text-center">Distribuição de Feedbacks</h3>
                    <div style="height: 250px;"><canvas id="rejection-rate-chart"></canvas></div>
                </div>
            </section>

            <!-- Feeds Lado a Lado -->
            <section class="grid grid-cols-1 md:grid-cols-2 md:items-start gap-6 mb-10">
                
                <!-- Coluna Feed Observações -->
                <section>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-900">Feed de Observações</h2>
                        <select id="observation-segment-filter" class="border-gray-300 rounded-lg shadow-sm text-sm p-1">
                             <option value="">Todos os Segmentos</option>
                             <!-- Populado por JS -->
                        </select>
                    </div>
                    <div id="observations-feed-list" class="space-y-4 bg-white p-4 rounded-2xl shadow-sm border no-scrollbar">
                        <p class="text-gray-500 placeholder-observation">Nenhuma observação encontrada.</p>
                    </div>
                </section>

                <!-- Coluna Post-its P&D -->
                <section>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">Post-its (Notas Internas P&D)</h2>
                    <div class="mb-4">
                        <textarea id="post-it-input" rows="2" class="w-full border-gray-300 rounded-lg shadow-sm" placeholder="Escreva uma nota rápida (visível apenas para si e para o Admin)..."></textarea>
                        <button id="add-post-it-btn" class="mt-2 w-full bg-amber-500 text-white font-semibold py-2 rounded-lg hover:bg-amber-600">Adicionar Post-it</button>
                    </div>
                    <div id="post-it-list" class="space-y-3 bg-gray-50 p-4 rounded-2xl shadow-sm border border-gray-200 no-scrollbar">
                        <p class="text-gray-500 placeholder-postit">Nenhum post-it encontrado.</p>
                    </div>
                </section>
            </section>

            <!-- Tabela de Acessos (Admin) -->
            <section id="admin-access-section" class="hidden bg-white p-6 rounded-2xl shadow-sm border mb-10">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Acessos P&D (Admin)</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Área / Segmento</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Responsável</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Senha</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="pd-access-tbody" class="bg-white divide-y divide-gray-200">
                            <!-- Linhas inseridas pelo JS -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>

    <!-- Modais -->
    
    <!-- Modal de Amostras por Feedback (Genérico) -->
    <div id="feedback-samples-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-30">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 id="feedback-samples-title" class="text-xl font-bold">Amostras</h3>
                <button id="close-feedback-samples-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="feedback-samples-list" class="space-y-3 pr-2 no-scrollbar">
                <p class="text-gray-500">A carregar detalhes...</p>
            </div>
        </div>
    </div>

    <!-- Modal de Resposta P&D (substitui o 'reply-modal') -->
    <div id="pd-reply-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-xl p-6">
            <h3 class="text-xl font-bold mb-4">Responder ao Vendedor (via P&D)</h3>
            <div class="mb-4 p-3 bg-gray-100 rounded border text-sm">
                <p class="font-semibold" id="pd-reply-modal-product"></p>
                <p class="text-xs text-gray-600 mb-1" id="pd-reply-modal-seller"></p>
                <p class="italic" id="pd-reply-modal-observation">"${' '}"</p>
            </div>
            <div class="space-y-4">
                  <div>
                       <label for="pd-reply-message-input" class="block text-sm font-medium text-gray-700">Sua Resposta (P&D)</label>
                       <textarea id="pd-reply-message-input" rows="3" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm" placeholder="Digite sua resposta aqui..."></textarea>
                  </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                 <button id="cancel-pd-reply-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-5 rounded-lg">Cancelar</button>
                 <button id="send-pd-reply-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Enviar Resposta</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Adicionar Nota Post-it (a partir de uma observação) -->
    <div id="postit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-xl p-6">
            <h3 class="text-xl font-bold mb-4">Adicionar Nota P&D</h3>
            <div class="mb-4 p-3 bg-gray-100 rounded border text-sm">
                <p class="font-semibold" id="postit-modal-context"></p>
                <p class="text-xs text-gray-600" id="postit-modal-description"></p>
                <p class="italic mt-2" id="postit-modal-observation">"${' '}"</p>
            </div>
            <div class="space-y-4">
                  <div>
                       <label for="postit-message-input" class="block text-sm font-medium text-gray-700">Nota Interna P&D (Visível apenas para si e Admin)</label>
                       <textarea id="postit-message-input" rows="3" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm" placeholder="Digite a nota..."></textarea>
                  </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                 <button id="cancel-postit-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-5 rounded-lg">Cancelar</button>
                 <button id="send-postit-btn" class="bg-amber-500 text-white font-semibold py-2 px-5 rounded-lg">Adicionar Nota</button>
            </div>
        </div>
    </div>

    <!-- Modal de Notificações (Respostas dos Gestores) -->
    <div id="notification-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold">Respostas (Vendedores/Gerentes)</h3>
                <button id="close-notification-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="notification-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2 no-scrollbar">
                <p class="text-gray-500">Nenhuma resposta recebida.</p>
            </div>
        </div>
    </div>

    <!-- Modal de Alerta Customizado -->
    <div id="custom-alert" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
            <h3 id="custom-alert-title" class="text-xl font-bold mb-4 text-red-600">Erro na Operação</h3>
            <p id="custom-alert-message" class="text-gray-700 mb-6">Ocorreu um erro.</p>
            <div class="flex justify-end">
                <button id="custom-alert-ok-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">OK</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot, doc, getDoc, getDocs, 
            updateDoc, query, orderBy, serverTimestamp, addDoc, limit, where,
            collectionGroup, Timestamp, runTransaction, writeBatch, deleteDoc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAF_TE28Tbp2nakBGTva1yEEbBCqWvRdJQ",
            authDomain: "feedback-vendedores.firebaseapp.com",
            projectId: "feedback-vendedores",
            storageBucket: "feedback-vendedores.firebasestorage.app",
            messagingSenderId: "650880422749",
            appId: "1:650880422749:web:54a258964a6ca8db180eb4",
            measurementId: "G-TG588KDK0C"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Definições de Acesso
        const PD_PASSWORDS = {
            'Panificação': { name: 'Adriana', pass: 'pd_adriana5', prefixes: ['DPAN'] },
            'Cárneos': { name: 'Anderson', pass: 'pd_anderson3', prefixes: ['DES'] }, // Assumindo DES para Cárneos
            'Aromas Doces, Salgados e Molhos': { name: 'Carlos', pass: 'pd_carlos1', prefixes: ['DES'] }, // Assumindo DES
            'Nutracêuticos': { name: 'Daise', pass: 'pd_daise4', prefixes: ['DMIX'] },
            'Lácteos': { name: 'Flavia', pass: 'pd_flavia2', prefixes: ['DLA', 'DLS'] },
            'Sorvetes': { name: 'Margarida', pass: 'pd_margarida7', prefixes: ['DSO'] },
            'Nutrição Animal': { name: 'Rebeca', pass: 'pd_rebeca6', prefixes: ['DNA'] },
            'ADMIN': { name: 'Admin', pass: 'admin123', prefixes: [] } // Admin vê tudo
        };
        const PENDING_STATUSES = ['EM ANÁLISE', 'AMOSTRA SEM FEEDBACK', 'SEM RETORNO DO CLIENTE', 'AMOSTRA NÃO TESTADA', 'PENDENTE'];
        
        // --- Elementos DOM ---
        const loginView = document.getElementById('login-view');
        // ALTERADO: de pdLoginButtons para pdSegmentSelect
        const pdSegmentSelect = document.getElementById('pd-segment-select');
        const pdPasswordInput = document.getElementById('pd-password-input');
        const pdLoginBtn = document.getElementById('pd-login-btn');
        const loginError = document.getElementById('login-error');
        const dashboard = document.getElementById('dashboard');
        const dashboardTitle = document.getElementById('dashboard-title');
        const logoutBtn = document.getElementById('logout-btn');
        const globalSearchInput = document.getElementById('global-search-input');
        const loadingState = document.getElementById('loading-state');
        const loadingMessage = document.getElementById('loading-message');
        const dashboardContent = document.getElementById('dashboard-content');
        const observationSegmentFilter = document.getElementById('observation-segment-filter');
        const observationsFeedList = document.getElementById('observations-feed-list');
        const postItInput = document.getElementById('post-it-input');
        const addPostItBtn = document.getElementById('add-post-it-btn');
        const postItList = document.getElementById('post-it-list');
        const adminAccessSection = document.getElementById('admin-access-section');
        const pdAccessTbody = document.getElementById('pd-access-tbody');
        const feedbackSamplesModal = document.getElementById('feedback-samples-modal');
        const feedbackSamplesTitle = document.getElementById('feedback-samples-title');
        const feedbackSamplesList = document.getElementById('feedback-samples-list');
        const closeFeedbackSamplesBtn = document.getElementById('close-feedback-samples-btn');
        const pdReplyModal = document.getElementById('pd-reply-modal');
        const pdReplyModalProduct = document.getElementById('pd-reply-modal-product');
        const pdReplyModalSeller = document.getElementById('pd-reply-modal-seller');
        const pdReplyModalObservation = document.getElementById('pd-reply-modal-observation');
        const pdReplyMessageInput = document.getElementById('pd-reply-message-input');
        const cancelPdReplyBtn = document.getElementById('cancel-pd-reply-btn');
        const sendPdReplyBtn = document.getElementById('send-pd-reply-btn');
        const postitModal = document.getElementById('postit-modal');
        const postitModalContext = document.getElementById('postit-modal-context');
        const postitModalDescription = document.getElementById('postit-modal-description');
        const postitModalObservation = document.getElementById('postit-modal-observation');
        const postitMessageInput = document.getElementById('postit-message-input');
        const cancelPostitBtn = document.getElementById('cancel-postit-btn');
        const sendPostitBtn = document.getElementById('send-postit-btn');
        const notificationModal = document.getElementById('notification-modal');
        const notificationList = document.getElementById('notification-list');
        const closeNotificationBtn = document.getElementById('close-notification-btn');
        let notificationBtn = null; // Definido dinamicamente
        const customAlert = document.getElementById('custom-alert');
        const customAlertTitle = document.getElementById('custom-alert-title');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertOkBtn = document.getElementById('custom-alert-ok-btn');

        // --- Estado Global ---
        let currentSessionId = null;
        let currentSegment = null; // Segmento de P&D logado
        let currentPdManagerName = null; // Nome do P&D logado
        let currentPrefixes = []; // Prefixos do P&D logado
        let allCurrentSamples = []; // Armazena TODAS as amostras carregadas
        let sellerSegmentsCache = {}; // Cache de segmentos de vendedores
        let sellerRepliesListenerUnsubscribe = null; // Respostas dos vendedores
        let managerRepliesListenerUnsubscribe = null; // Respostas dos gerentes (para P&D)
        let pdPostitsListenerUnsubscribe = null; // Notas P&D (para feed)
        let dataListenersUnsubscribe = [];
        let chartInstances = {};
        let currentSampleForReply = null;
        let currentSampleForPostit = null;
        let allSellerReplies = []; // Respostas dos vendedores para o gerente
        let allManagerReplies = []; // Respostas dos gerentes para os vendedores (para o feed)
        let allPdPostits = []; // Post-its do P&D (para o feed)
        
        // Classe de Gestão de Carga
        class DataLoadManager {
            constructor(totalItems, onComplete) {
                this.totalItems = totalItems;
                this.loadedItems = 0;
                this.allData = [];
                this.onComplete = onComplete;
                this.hasCompleted = false;
            }

            sellerLoaded(sellerName, samples) {
                this.loadedItems++;
                const samplesWithOwner = samples.map(s => ({ ...s, sellerName }));
                this.allData = this.allData.concat(samplesWithOwner);
                
                const progress = this.totalItems > 0 ? (this.loadedItems / this.totalItems) * 100 : 100;
                loadingMessage.textContent = `A processar... (${this.loadedItems}/${this.totalItems} vendedores carregados)`;

                if (this.loadedItems === this.totalItems && !this.hasCompleted) {
                    this.hasCompleted = true;
                    this.onComplete(this.allData);
                }
            }
        }

        // --- Funções Utilitárias ---
        const normalizeText = (text = '') => text ? text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim() : '';

        function showAlert(message, title = "Erro na Operação", color = "text-red-600") {
            customAlertTitle.textContent = title;
            customAlertMessage.innerHTML = message; // Usar innerHTML para permitir <br>
            customAlertTitle.className = `text-xl font-bold mb-4 ${color}`;
            customAlert.classList.remove('hidden');
        }
        customAlertOkBtn.addEventListener('click', () => customAlert.classList.add('hidden'));

        function handleFirestoreError(error, operationContext) {
            console.error(`Erro em "${operationContext}":`, error);
            let message = `Não foi possível completar a operação: ${operationContext}.<br><br>Erro: ${error.message}`;
            let title = "Erro na Operação";
            let color = "text-red-600";

            if (error.code === 'resource-exhausted' || (error.message && error.message.includes('Quota exceeded'))) {
                message = "O limite diário de uso do banco de dados foi atingido (Quota Exceeded). Novas alterações não serão salvas hoje.<br><br>Por favor, tente novamente amanhã ou contate o suporte.";
                title = "Limite da Plataforma Atingido";
                color = "text-amber-600";
            } else if (error.code === 'permission-denied') {
                message = "Permissão negada. Verifique as regras de segurança do Firebase.";
            }
            showAlert(message, title, color);
        }

        // --- Lógica de Carregamento de Dados (v2) ---
        
        // CORREÇÃO: Funções de listener definidas ANTES de serem chamadas
        function listenForManagerReplies(sessionId) {
            if (managerRepliesListenerUnsubscribe) managerRepliesListenerUnsubscribe();
            const q = query(collection(db, "sessoes", sessionId, "notificacoesVendedor"));
            
            managerRepliesListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                 allManagerReplies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 if (!dashboardContent.classList.contains('hidden')) {
                     renderObservationsFeed(allCurrentSamples);
                 }
            }, (error) => handleFirestoreError(error, "ouvir respostas dos gestores (feed)"));
        }
        
        function listenForSellerRepliesFeed(sessionId) {
            const q = query(collection(db, "sessoes", sessionId, "respostasVendedor"));
            
            const unsub = onSnapshot(q, (snapshot) => {
                 allSellerReplies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 if (!dashboardContent.classList.contains('hidden')) {
                     renderObservationsFeed(allCurrentSamples);
                 }
            }, (error) => handleFirestoreError(error, "ouvir respostas dos vendedores (feed)"));
            dataListenersUnsubscribe.push(unsub);
        }

        function listenForPdPostits(sessionId) {
            if (pdPostitsListenerUnsubscribe) pdPostitsListenerUnsubscribe();
            const q = query(collection(db, "sessoes", sessionId, "pdPostits"));
            
            pdPostitsListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                 allPdPostits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 if (!dashboardContent.classList.contains('hidden')) {
                     renderPostItList(allPdPostits); 
                 }
            }, (error) => handleFirestoreError(error, "ouvir post-its P&D (feed)"));
        }

        function listenForSellerReplies(sessionId) {
            if (sellerRepliesListenerUnsubscribe) sellerRepliesListenerUnsubscribe();
            const q = query(
                collection(db, "sessoes", sessionId, "respostasVendedor"),
                where("readByPd", "==", false)
            );
            
            sellerRepliesListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                 renderNotificationBell(snapshot.docs.length);
            }, (error) => handleFirestoreError(error, "ouvir respostas de vendedores (notificação)"));
        }

        
        async function getActiveSessionId() {
            try {
                const activeSessionRef = doc(db, "configuracoes", "sessaoAtiva");
                const docSnap = await getDoc(activeSessionRef);
                if (docSnap.exists() && docSnap.data().current) {
                    return docSnap.data().current;
                } else {
                    return null;
                }
            } catch (error) {
                handleFirestoreError(error, "buscar sessão ativa");
                return null;
            }
        }

        async function loadSellerSegments() {
            sellerSegmentsCache = {};
            try {
                const segmentsSnap = await getDocs(collection(db, "vendedorConfig"));
                segmentsSnap.forEach(doc => {
                    sellerSegmentsCache[doc.id] = doc.data().segmento;
                });
                console.log("Cache de segmentos carregado:", sellerSegmentsCache);
                populateSegmentFilters(); // Popula os filtros de segmento
            } catch (error) {
                handleFirestoreError(error, "carregar segmentos de vendedores");
            }
        }

        async function loadAllData(sessionId) {
            dashboard.classList.remove('hidden');
            loadingState.classList.remove('hidden');
            dashboardContent.classList.add('hidden');
            loginView.classList.add('hidden');
            
            dataListenersUnsubscribe.forEach(unsub => unsub());
            dataListenersUnsubscribe = [];
            
            currentSessionId = sessionId;
            allCurrentSamples = [];

            // 1. Carrega os segmentos
            await loadSellerSegments();

            // 2. Ouve as notificações (Sino)
            listenForSellerReplies(sessionId);
            // 3. Ouve as threads de comunicação (Feed)
            listenForManagerReplies(sessionId);
            listenForSellerRepliesFeed(sessionId);
            listenForPdPostits(sessionId);

            // 4. Busca todos os vendedores da sessão
            const sellersQuery = query(collection(db, "sessoes", sessionId, "vendedores"));
            const sellersSnapshot = await getDocs(sellersQuery);
            const sellerDocs = sellersSnapshot.docs;
            
            if (sellerDocs.length === 0) {
                 console.log("Nenhum vendedor encontrado para esta sessão.");
                 loadingState.classList.add('hidden');
                 dashboardContent.classList.remove('hidden');
                 processAndDisplayDashboard([]);
                 return;
            }

            // 5. Usa o DataLoadManager para carregar as sub-coleções
            const loadManager = new DataLoadManager(sellerDocs.length, (allSamples) => {
                
                // --- FILTRO DE P&D (v2) ---
                let filteredSamples;
                if (currentSegment === 'ADMIN') {
                    filteredSamples = allSamples; // Admin vê tudo
                } else {
                    // P&D vê amostras com base no prefixo do produto
                    filteredSamples = allSamples.filter(sample => {
                        const productCode = normalizeText(sample.produto);
                        // Verifica se o código do produto começa com algum dos prefixos do P&D
                        return currentPrefixes.some(prefix => productCode.startsWith(prefix));
                    });
                }
                // --- FIM DO FILTRO ---

                allCurrentSamples = filteredSamples; // Armazena SOMENTE as amostras filtradas
                processAndDisplayDashboard(allCurrentSamples); // Passa somente as amostras filtradas
                
                loadingState.classList.add('hidden');
                dashboardContent.classList.remove('hidden');
            });
            
            loadingMessage.textContent = `A preparar para carregar ${sellerDocs.length} vendedores...`;

            // 6. Ouve as 'amostras' de cada vendedor
            sellerDocs.forEach(sellerDoc => {
                const sellerData = sellerDoc.data();
                const samplesQuery = query(
                    collection(db, sellerDoc.ref.path, "amostras")
                );

                const unsub = onSnapshot(samplesQuery, (samplesSnapshot) => {
                    const samples = samplesSnapshot.docs.map(sampleDoc => ({
                        ...sampleDoc.data(),
                        id: sampleDoc.id,
                        sellerDocRef: sellerDoc.ref.path // Guarda a referência do vendedor
                    }));
                    loadManager.sellerLoaded(sellerData.originalName, samples);
                }, (error) => {
                    handleFirestoreError(error, `ouvir amostras de ${sellerData.originalName}`);
                    loadManager.sellerLoaded(sellerData.originalName, []);
                });
                dataListenersUnsubscribe.push(unsub);
            });
        }

        // --- Lógica de Login ---
        
        // ALTERADO: de populatePdButtons para populatePdLoginSelect
        function populatePdLoginSelect() {
            pdSegmentSelect.innerHTML = '<option value="">Selecione...</option>';

            Object.entries(PD_PASSWORDS).forEach(([segment, data]) => {
                const option = document.createElement('option');
                option.value = segment;
                option.textContent = `${segment} (${data.name})`;
                pdSegmentSelect.appendChild(option);
            });
        }

        async function login() {
            // ALTERADO: Lê o segmento do select
            const selectedSegment = pdSegmentSelect.value;
            const password = pdPasswordInput.value;
            
            if (!selectedSegment) {
                loginError.textContent = 'Por favor, selecione a sua área.';
                return;
            }
            
            // Pega os dados do segmento selecionado
            const segmentData = PD_PASSWORDS[selectedSegment];

            if (segmentData && segmentData.pass === password) {
                loginError.textContent = '';
                pdLoginBtn.disabled = true;
                pdLoginBtn.textContent = 'A carregar...';

                // Define o estado global
                currentSegment = selectedSegment;
                currentPdManagerName = segmentData.name;
                currentPrefixes = segmentData.prefixes;
                
                localStorage.setItem('pdSegment', currentSegment); 
                
                const sessionId = await getActiveSessionId();
                if (!sessionId) {
                    loginError.textContent = 'Nenhuma sessão ativa encontrada. Contate o administrador.';
                    pdLoginBtn.disabled = false;
                    pdLoginBtn.textContent = 'Entrar';
                    return;
                }
                
                dashboardTitle.textContent = `Painel P&D: ${currentSegment}`;
                if (currentSegment === 'ADMIN') {
                    adminAccessSection.classList.remove('hidden');
                    renderAccessTable();
                }
                
                await loadAllData(sessionId);

            } else {
                loginError.textContent = 'Senha ou área incorreta.';
            }
        }
        
        function logout() {
            localStorage.removeItem('pdSegment');
            currentSessionId = null;
            currentSegment = null;
            currentPdManagerName = null;
            currentPrefixes = [];
            allCurrentSamples = [];
            allManagerReplies = [];
            allSellerReplies = [];
            allPdPostits = [];
            dataListenersUnsubscribe.forEach(unsub => unsub());
            dataListenersUnsubscribe = [];
            if(sellerRepliesListenerUnsubscribe) sellerRepliesListenerUnsubscribe();
            if(managerRepliesListenerUnsubscribe) managerRepliesListenerUnsubscribe();
            if(pdPostitsListenerUnsubscribe) pdPostitsListenerUnsubscribe();
            
            dashboard.classList.add('hidden');
            loginView.classList.remove('hidden');
            pdPasswordInput.value = '';
            pdSegmentSelect.value = ''; // Reseta o dropdown
            pdLoginBtn.disabled = false;
            pdLoginBtn.textContent = 'Entrar';
            adminAccessSection.classList.add('hidden');
            
            // Remove o sino
            document.getElementById('notification-btn')?.parentElement.remove();
        }

        // --- Processamento e Renderização do Dashboard ---
        function processAndDisplayDashboard(samples) {
            if (!samples) return;
            renderCharts(samples);
            renderObservationsFeed(samples);
            renderPostItList(allPdPostits); 
        }

        function populateSegmentFilters() {
             const currentSegments = [...new Set(Object.values(sellerSegmentsCache).filter(Boolean))].sort();
             observationSegmentFilter.innerHTML = '<option value="">Todos os Segmentos</option>';
             
             currentSegments.forEach(segment => {
                 const option = document.createElement('option');
                 option.value = segment;
                 option.textContent = segment;
                 observationSegmentFilter.appendChild(option);
             });
        }

        function renderCharts(samples) {
            let pending = 0, resolved = 0, approved = 0, rejected = 0, events = 0;
            const APPROVED_PREFIX = 'A -';
            const REJECTED_PREFIX = 'R -';
            const EVENTS_PREFIX = 'E -';

            samples.forEach(s => {
                if (s.isPending) {
                    pending++;
                } else {
                    resolved++;
                    const feedback = s.feedback || '';
                    if (feedback.startsWith(APPROVED_PREFIX)) approved++;
                    else if (feedback.startsWith(REJECTED_PREFIX)) rejected++;
                    else if (feedback.startsWith(EVENTS_PREFIX)) events++;
                }
            });

            const statusTitle = document.querySelector('#segment-status-chart').closest('.bg-white').querySelector('h3');
            if (currentSegment !== 'ADMIN') {
                 statusTitle.textContent = "Status (Amostras do Segmento)";
            }

            renderChart('segment-status-chart', 'doughnut', {
                labels: ['Pendentes', 'Resolvidos'],
                datasets: [{ data: [pending, resolved], backgroundColor: ['#facc15', '#3b82f6'] }]
            });

            if (approved === 0 && rejected === 0 && events === 0 && resolved > 0) {
                 renderChart('rejection-rate-chart', 'doughnut', { labels: ['Aguardando Feedbacks'], datasets: [{ data: [resolved], backgroundColor: ['#e5e7eb'] }] });
            } else if (approved === 0 && rejected === 0 && events === 0) {
                 renderChart('rejection-rate-chart', 'doughnut', { labels: ['Aguardando Respostas'], datasets: [{ data: [1], backgroundColor: ['#e5e7eb'] }] });
            } else {
                renderChart('rejection-rate-chart', 'doughnut', {
                    labels: ['Aprovadas', 'Reprovadas', 'Eventos'],
                    datasets: [{
                        data: [approved, rejected, events],
                        backgroundColor: ['#34d399', '#f87171', '#a78bfa']
                    }]
                });
            }
        }

        function renderChart(canvasId, type, data, options = {}) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return;
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            
            Chart.register(ChartDataLabels);
            chartInstances[canvasId] = new Chart(ctx, { 
                type, 
                data, 
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: type === 'doughnut' },
                        datalabels: { display: false },
                        ...options.plugins
                    },
                    ...options
                }
            });
        }
        
        // Feed de Observações (Melhorado)
        function renderObservationsFeed(samples) {
            const globalSearch = normalizeText(globalSearchInput.value);
            const segmentFilter = observationSegmentFilter.value;
            
            const filteredSamples = samples.filter(s => {
                if (!s.observation) return false;
                
                // Filtro de Segmento (do Vendedor)
                if(segmentFilter && sellerSegmentsCache[normalizeText(s.sellerName)] !== segmentFilter) {
                    return false;
                }
                
                // Filtro de Pesquisa Global
                if (globalSearch) {
                    return (
                        normalizeText(s.sellerName).includes(globalSearch) ||
                        normalizeText(s.produto).includes(globalSearch) ||
                        normalizeText(s.descricao).includes(globalSearch) ||
                        normalizeText(s.razaoSocial).includes(globalSearch) ||
                        normalizeText(s.observation).includes(globalSearch) ||
                        normalizeText(s.pedido).includes(globalSearch)
                    );
                }
                return true;
                
            }).sort((a, b) => (b.lastUpdate?.toDate ? b.lastUpdate.toDate().getTime() : 0) - (a.lastUpdate?.toDate ? a.lastUpdate.toDate().getTime() : 0));
            
            observationsFeedList.innerHTML = '';
            if (filteredSamples.length === 0) {
                 const msg = globalSearch ? 'Nenhum resultado para a pesquisa.' : 'Nenhuma observação encontrada.';
                 observationsFeedList.innerHTML = `<p class="text-gray-500 placeholder-observation p-4">${msg}</p>`;
                 return;
            }
            
            filteredSamples.forEach(sample => {
                 const card = document.createElement('div');
                 card.className = "p-4 border-b border-gray-100 last:border-b-0";
                 const time = sample.lastUpdate?.toDate() ? sample.lastUpdate.toDate().toLocaleString('pt-BR') : 'data inválida';
                 
                 // --- Lógica da Thread de Comunicação ---
                 let repliesHtml = '';
                 
                 // 1. Nota P&D (se houver)
                 const pdNote = allPdPostits.find(p => p.contextId === sample.id);
                 if (pdNote) {
                      repliesHtml += `
                         <div class="pd-note">
                             <p><strong>Nota P&D (${pdNote.pdManagerName}):</strong> ${pdNote.message}</p>
                         </div>
                     `;
                 }
                 
                 // 2. Resposta do Gestor (incluindo P&D)
                 const managerReply = allManagerReplies
                    .filter(r => r.sellerName === sample.sellerName && r.pedido === sample.pedido && r.produto === sample.produto && r.originalObservation === sample.observation)
                    .sort((a, b) => (b.timestamp?.toDate() ?? 0) - (a.timestamp?.toDate() ?? 0))[0];
                 
                 if (managerReply) {
                     const isPD = managerReply.managerName.includes('P&D');
                     repliesHtml += `
                         <div class="${isPD ? 'pd-note' : 'manager-reply'}">
                             <p><strong>${managerReply.managerName} respondeu:</strong> ${managerReply.replyMessage}</p>
                         </div>
                     `;
                     
                     // 3. Resposta do Vendedor (a essa resposta)
                     const sellerReply = allSellerReplies
                        .filter(r => r.originalManagerMessage === managerReply.replyMessage && r.pedido === sample.pedido && r.produto === sample.produto)
                        .sort((a, b) => (b.timestamp?.toDate() ?? 0) - (a.timestamp?.toDate() ?? 0))[0];
                     
                     if (sellerReply) {
                         repliesHtml += `
                             <div class="seller-reply">
                                 <p><strong>${sellerReply.sellerName} (Vendedor) respondeu:</strong> ${sellerReply.replyMessage}</p>
                             </div>
                         `;
                     }
                 }
                 // --- Fim da Lógica da Thread ---
                 
                 card.innerHTML = `
                    <div class="mb-2">
                        <p class="font-bold text-gray-800">${sample.produto}</p>
                        <!-- NOVO: Descrição e Faturamento -->
                        <p class="text-sm text-gray-600">${sample.descricao || 'Sem descrição'}</p>
                        <p class="text-xs text-gray-500">${sample.razaoSocial || 'Cliente N/A'} | Fat.: ${sample.emissaoNF || 'N/A'}</p>
                    </div>
                    <p class="text-gray-700 mb-3 italic">"${sample.observation}"</p>
                    
                    ${repliesHtml}

                    <div class="flex justify-between items-end text-xs text-gray-500 mt-3 pt-3 border-t">
                         <div>
                             <p>- ${sample.sellerName} (Pedido: ${sample.pedido})</p>
                             <p class="text-gray-400">Obs.: ${time}</p>
                         </div>
                         <div class="flex gap-2">
                            <button class="postit-btn bg-amber-100 text-amber-700 hover:bg-amber-200 px-2 py-1 rounded text-xs font-semibold" data-sample-id="${sample.id}">
                                Adicionar Nota
                            </button>
                             <button class="reply-btn bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded text-xs font-semibold" data-sample-id="${sample.id}">
                                 Responder
                             </button>
                         </div>
                    </div>
                 `;
                 observationsFeedList.appendChild(card);
            });
            
            // Listeners
            observationsFeedList.querySelectorAll('.reply-btn').forEach(btn => {
                 btn.addEventListener('click', openPdReplyModal);
            });
            observationsFeedList.querySelectorAll('.postit-btn').forEach(btn => {
                 btn.addEventListener('click', openPostitModal);
            });
        }
        
        // Lista de Post-its
        function renderPostItList(postits) {
            postItList.innerHTML = '';
            
            // NOVO: Filtra post-its por segmento
            const filteredPostits = postits.filter(note => {
                if (currentSegment === 'ADMIN') return true; // Admin vê tudo
                return note.segment === currentSegment; // Outros veem apenas os seus
            }).sort((a, b) => (b.timestamp?.toDate ? b.timestamp.toDate().getTime() : 0) - (a.timestamp?.toDate ? a.timestamp.toDate().getTime() : 0));
            
            if (filteredPostits.length === 0) {
                 postItList.innerHTML = `<p class="text-gray-500 placeholder-postit">Nenhum post-it encontrado.</p>`;
                 return;
            }
            
            filteredPostits.forEach(note => {
                 const card = document.createElement('div');
                 card.className = 'p-3 rounded-lg border bg-white shadow-sm';
                 const time = note.timestamp?.toDate() ? note.timestamp.toDate().toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) : '';
                 
                 card.innerHTML = `
                    <p class="text-sm text-gray-800">${note.message}</p>
                    ${note.context ? `<p class="text-xs text-gray-500 mt-2 pt-2 border-t">Ref: ${note.context}</p>` : ''}
                    <div class="flex justify-between items-center mt-2 text-xs">
                        <span class="font-semibold ${note.segment ? 'text-purple-700' : 'text-gray-600'}">${note.pdManagerName}</span>
                        <div class="flex items-center gap-2">
                             <span class="text-gray-400">${time}</span>
                             <button class="delete-post-it-btn text-gray-400 hover:text-red-500" data-id="${note.id}" title="Excluir">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                             </button>
                        </div>
                    </div>
                 `;
                 postItList.appendChild(card);
            });
        }

        async function addPostItFromInput() {
             const message = postItInput.value.trim();
             if (!message) return;
             
             addPostItBtn.disabled = true;
             
             try {
                const postItData = {
                    message,
                    pdManagerName: currentPdManagerName,
                    segment: currentSegment, // NOVO: Etiqueta o segmento
                    context: "Nota Geral",
                    contextId: null,
                    timestamp: serverTimestamp()
                };
                await addDoc(collection(db, "sessoes", currentSessionId, "pdPostits"), postItData);
                postItInput.value = '';
             } catch(error) {
                 handleFirestoreError(error, "adicionar post-it geral");
             } finally {
                 addPostItBtn.disabled = false;
             }
        }
        
        async function deletePostIt(e) {
             const id = e.currentTarget.dataset.id;
             if (!id) return;
             
             // Simples confirmação, idealmente usar um modal
             if (!confirm("Tem a certeza que quer excluir esta nota?")) return;
             
             e.currentTarget.disabled = true;
             
             try {
                const docRef = doc(db, "sessoes", currentSessionId, "pdPostits", id);
                await deleteDoc(docRef);
             } catch(error) {
                 handleFirestoreError(error, "excluir post-it");
                 e.currentTarget.disabled = false;
             }
             // Listener atualiza a UI
        }

        
        function renderAccessTable() {
             pdAccessTbody.innerHTML = '';
             Object.entries(PD_PASSWORDS).forEach(([segment, data]) => {
                 if(segment === 'ADMIN') return;
                 const row = document.createElement('tr');
                 row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${segment}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 password-cell" data-password="${data.pass}">••••••</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="toggle-password-btn text-blue-600 hover:text-blue-800" data-state="hidden">Visualizar</button>
                    </td>
                 `;
                 pdAccessTbody.appendChild(row);
             });
        }

        // --- Lógica de Resposta e Notificação ---
        
        function openPdReplyModal(e) {
             const sampleId = e.currentTarget.dataset.sampleId;
             currentSampleForReply = allCurrentSamples.find(s => s.id === sampleId);
             if (!currentSampleForReply) return showAlert("Erro: Amostra não encontrada.");
             
             pdReplyModalProduct.textContent = `${currentSampleForReply.produto} (${currentSampleForReply.pedido})`;
             pdReplyModalSeller.textContent = `Observação de: ${currentSampleForReply.sellerName}`;
             pdReplyModalObservation.textContent = `"${currentSampleForReply.observation}"`;
             pdReplyMessageInput.value = '';
             pdReplyModal.classList.remove('hidden');
        }
        
        function openPostitModal(e) {
             const sampleId = e.currentTarget.dataset.sampleId;
             currentSampleForPostit = allCurrentSamples.find(s => s.id === sampleId);
             if (!currentSampleForPostit) return showAlert("Erro: Amostra não encontrada.");
             
             postitModalContext.textContent = `Ref: ${currentSampleForPostit.produto} (${currentSampleForPostit.pedido})`;
             postitModalDescription.textContent = currentSampleForPostit.descricao || 'Sem descrição';
             postitModalObservation.textContent = `"${currentSampleForPostit.observation}"`;
             postitMessageInput.value = '';
             postitModal.classList.remove('hidden');
        }

        async function sendPdReply() {
            if (!currentSampleForReply || !currentSessionId) return;
            
            const replyMessage = pdReplyMessageInput.value.trim();
            if (!replyMessage || !currentPdManagerName) {
                return showAlert("A mensagem de resposta não pode estar vazia.");
            }

            sendPdReplyBtn.disabled = true;
            sendPdReplyBtn.textContent = 'A Enviar...';

            try {
                // P&D envia para a coleção 'notificacoesVendedor'
                const notificationData = {
                    managerName: `${currentPdManagerName} (P&D)`, // Identifica que é do P&D
                    replyMessage: replyMessage,
                    originalObservation: currentSampleForReply.observation,
                    sellerName: currentSampleForReply.sellerName,
                    pedido: currentSampleForReply.pedido,
                    produto: currentSampleForReply.produto,
                    razaoSocial: currentSampleForReply.razaoSocial || '',
                    descricao: currentSampleForReply.descricao || '',
                    timestamp: serverTimestamp(),
                    read: false,
                    readByPd: true // O P&D "leu" ao enviar
                };

                const sellerNotifsRef = collection(db, "sessoes", currentSessionId, "notificacoesVendedor");
                await addDoc(sellerNotifsRef, notificationData);

                pdReplyModal.classList.add('hidden');
                showAlert("Resposta enviada com sucesso.", "Sucesso", "text-green-600");
                
            } catch (error) {
                handleFirestoreError(error, "enviar resposta P&D ao vendedor");
            } finally {
                sendPdReplyBtn.disabled = false;
                sendPdReplyBtn.textContent = 'Enviar Resposta';
                currentSampleForReply = null;
            }
        }
        
        async function sendPostIt() {
             if (!currentSampleForPostit || !currentSessionId) return;
             
             const message = postitMessageInput.value.trim();
             if (!message) {
                 return showAlert("A nota não pode estar vazia.");
             }
             
             sendPostitBtn.disabled = true;
             sendPostitBtn.textContent = 'A Adicionar...';
             
             try {
                const postItData = {
                    message,
                    pdManagerName: currentPdManagerName,
                    segment: currentSegment, // NOVO: Etiqueta o segmento
                    context: `${currentSampleForPostit.produto} (V: ${currentSampleForPostit.sellerName}, P: ${currentSampleForPostit.pedido})`,
                    contextId: currentSampleForPostit.id, // ID da amostra
                    timestamp: serverTimestamp()
                };
                await addDoc(collection(db, "sessoes", currentSessionId, "pdPostits"), postItData);
                
                postitModal.classList.add('hidden');
                showAlert("Nota P&D adicionada com sucesso.", "Sucesso", "text-green-600");
                
             } catch(error) {
                handleFirestoreError(error, "adicionar post-it de amostra");
             } finally {
                 sendPostitBtn.disabled = false;
                 sendPostitBtn.textContent = 'Adicionar Nota';
                 currentSampleForPostit = null;
             }
        }
        
        // Sino de Notificação (mostra respostas de Vendedores e Gerentes)
        function renderNotificationBell(unreadCount) {
             let countBadge = document.getElementById('notification-count-badge');
             
             if (!notificationBtn) {
                const header = document.querySelector('#dashboard header .flex.items-center.gap-4');
                if (!header) return; 
                const bellWrapper = document.createElement('div');
                bellWrapper.className = "relative";
                bellWrapper.innerHTML = `
                    <button id="notification-btn" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                        <span id="notification-count-badge" class="hidden absolute top-0 right-0 -mt-1 -mr-1 px-2 py-0.5 bg-red-500 text-white text-xs rounded-full">0</span>
                    </button>
                `;
                header.insertBefore(bellWrapper, logoutBtn);
                notificationBtn = document.getElementById('notification-btn');
                countBadge = document.getElementById('notification-count-badge');
                
                notificationBtn.addEventListener('click', openNotificationModal);
             }
             
             if (unreadCount > 0) {
                 countBadge.textContent = unreadCount;
                 countBadge.classList.remove('hidden');
             } else {
                 countBadge.classList.add('hidden');
             }
        }
        
        async function openNotificationModal() {
             notificationList.innerHTML = '';
             
             const q = query(
                collection(db, "sessoes", currentSessionId, "respostasVendedor"),
                where("readByPd", "==", false),
                orderBy("timestamp", "desc")
             );
             
             const snapshot = await getDocs(q);
             const replies = snapshot.docs;

             if (replies.length === 0) {
                 notificationList.innerHTML = '<p class="text-gray-500">Nenhuma resposta nova.</p>';
                 notificationModal.classList.remove('hidden');
                 return;
             }
             
             const batch = writeBatch(db);
             
             replies.forEach(replyDoc => {
                 const reply = replyDoc.data();
                 const item = document.createElement('div');
                 item.className = "p-3 border-b border-gray-100";
                 item.innerHTML = `
                    <p><span class="font-semibold text-green-600">${reply.sellerName}</span> (Vendedor) respondeu:</p>
                    <p class="italic text-gray-700 my-1">"${reply.replyMessage}"</p>
                    <p class="text-xs text-gray-500">Ref: ${reply.produto} (Pedido: ${reply.pedido})</p>
                    <p class="text-xs text-gray-400">Mensagem original: "${reply.originalManagerMessage}"</p>
                    <button class="mark-as-read-btn text-xs text-blue-500 hover:underline" data-id="${replyDoc.id}">Marcar como lida</button>
                 `;
                 notificationList.appendChild(item);
                 
                 // Não marca como lida automaticamente, espera o clique
             });
             
             notificationModal.classList.remove('hidden');
        }
        
        async function markReplyAsRead(e) {
             const id = e.target.dataset.id;
             if (!id) return;
             
             e.target.disabled = true;
             e.target.textContent = 'A marcar...';
             
             try {
                 const docRef = doc(db, "sessoes", currentSessionId, "respostasVendedor", id);
                 await updateDoc(docRef, { readByPd: true });
                 e.target.closest('.p-3').remove(); // Remove da lista
             } catch(error) {
                 handleFirestoreError(error, "marcar resposta como lida");
                 e.target.disabled = false;
                 e.target.textContent = 'Marcar como lida';
             }
        }
        
        // --- Modal de Amostras (Pesquisa Global) ---
        function openGlobalSearchModal(samples) {
            feedbackSamplesTitle.textContent = `Resultados da Pesquisa: "${globalSearchInput.value}" (${samples.length})`;
            feedbackSamplesList.innerHTML = '';
            
            if (samples.length === 0) {
                 feedbackSamplesList.innerHTML = '<p class="text-gray-500">Nenhum resultado encontrado.</p>';
                 feedbackSamplesModal.classList.remove('hidden');
                 return;
            }
            
            samples.forEach(sample => {
                 const itemDiv = document.createElement('div');
                 itemDiv.className = `feedback-sample-item text-sm`;
                 
                 let repliesHtml = '';
                 const pdNote = allPdPostits.find(p => p.contextId === sample.id);
                 if (pdNote) repliesHtml += `<div class="pd-note"><p><strong>Nota P&D:</strong> ${pdNote.message}</p></div>`;
                 const managerReply = allManagerReplies.find(r => r.sellerName === sample.sellerName && r.pedido === sample.pedido && r.produto === sample.produto && r.originalObservation === sample.observation);
                 if (managerReply) {
                     repliesHtml += `<div class="manager-reply"><p><strong>${managerReply.managerName}:</strong> ${managerReply.replyMessage}</p></div>`;
                     const sellerReply = allSellerReplies.find(r => r.originalManagerMessage === managerReply.replyMessage && r.pedido === sample.pedido);
                     if (sellerReply) repliesHtml += `<div class="seller-reply"><p><strong>${sellerReply.sellerName}:</strong> ${sellerReply.replyMessage}</p></div>`;
                 }

                 itemDiv.innerHTML = `
                     <div class="flex justify-between items-start">
                         <div>
                             <p class="font-semibold">${sample.produto} (${sample.razaoSocial})</p>
                             <p class="text-xs text-gray-600">${sample.descricao}</p>
                             <p class="text-xs text-gray-500 mt-1">
                                 Vendedor: ${sample.sellerName} | Pedido: ${sample.pedido} | NF: ${sample.emissaoNF || 'N/A'}
                             </p>
                             <p class="font-medium text-gray-800 mt-1">Feedback: ${sample.feedback || 'Pendente'}</p>
                         </div>
                     </div>
                     ${sample.observation ? `<p class="text-xs text-gray-600 mt-1 italic">Obs: ${sample.observation}</p>` : ''}
                     ${repliesHtml}
                 `;
                 feedbackSamplesList.appendChild(itemDiv);
            });
            
            feedbackSamplesModal.classList.remove('hidden');
        }


        // --- Event Listeners Globais ---
        pdLoginBtn.addEventListener('click', login);
        logoutBtn.addEventListener('click', logout);
        observationSegmentFilter.addEventListener('change', () => renderObservationsFeed(allCurrentSamples));
        
        globalSearchInput.addEventListener('keyup', (e) => {
            // Se pressionar Enter, abre o modal de pesquisa
            if (e.key === 'Enter') {
                const searchTerm = normalizeText(globalSearchInput.value);
                if (!searchTerm) {
                    renderObservationsFeed(allCurrentSamples);
                    return;
                }
                const filteredSamples = allCurrentSamples.filter(s => 
                    normalizeText(s.sellerName).includes(searchTerm) ||
                    normalizeText(s.produto).includes(searchTerm) ||
                    normalizeText(s.descricao).includes(searchTerm) ||
                    normalizeText(s.razaoSocial).includes(searchTerm) ||
                    (s.observation && normalizeText(s.observation).includes(searchTerm)) ||
                    normalizeText(s.pedido).includes(searchTerm)
                ).sort((a, b) => (b.lastUpdate?.toDate ? b.lastUpdate.toDate().getTime() : 0) - (a.lastUpdate?.toDate ? a.lastUpdate.toDate().getTime() : 0));
                
                openGlobalSearchModal(filteredSamples);
                
            } else { // Pesquisa em tempo real nos feeds
                renderObservationsFeed(allCurrentSamples);
            }
        });

        // Modais
        closeFeedbackSamplesBtn.addEventListener('click', () => feedbackSamplesModal.classList.add('hidden'));
        
        cancelPdReplyBtn.addEventListener('click', () => pdReplyModal.classList.add('hidden'));
        sendPdReplyBtn.addEventListener('click', sendPdReply);
        
        cancelPostitBtn.addEventListener('click', () => postitModal.classList.add('hidden'));
        sendPostitBtn.addEventListener('click', sendPostIt);
        
        // Caixa de Post-it principal
        addPostItBtn.addEventListener('click', addPostItFromInput);
        postItList.addEventListener('click', (e) => {
             const button = e.target.closest('.delete-post-it-btn');
             if (button) deletePostIt({ currentTarget: button });
        });

        // Modal de Notificações (Respostas dos Gestores)
        closeNotificationBtn.addEventListener('click', () => notificationModal.classList.add('hidden'));
        notificationList.addEventListener('click', (e) => {
            const button = e.target.closest('.mark-as-read-btn');
            if (button) markReplyAsRead({ target: button });
        });
        
        // Tabela de Acessos (Admin)
        pdAccessTbody.addEventListener('click', (e) => {
            const button = e.target.closest('.toggle-password-btn');
            if (button) {
                const cell = button.closest('tr').querySelector('.password-cell');
                const password = cell.dataset.password;

                if (button.dataset.state === 'hidden') {
                    cell.textContent = password;
                    button.textContent = 'Ocultar';
                    button.dataset.state = 'visible';
                } else {
                    cell.textContent = '••••••';
                    button.textContent = 'Visualizar';
                    button.dataset.state = 'hidden';
                }
            }
        });


        // --- INICIALIZAÇÃO ---
        (async () => {
            try {
                await signInAnonymously(auth); // Garante que estamos autenticados no Firebase
                // ALTERADO: de populatePdButtons para populatePdLoginSelect
                populatePdLoginSelect(); 
                
                // Tenta fazer login automático se já esteve logado
                const savedSegment = localStorage.getItem('pdSegment');
                if (savedSegment && PD_PASSWORDS[savedSegment]) {
                    // Define o estado global
                    currentSegment = savedSegment;
                    currentPdManagerName = PD_PASSWORDS[savedSegment].name;
                    currentPrefixes = PD_PASSWORDS[savedSegment].prefixes;
                    pdLoginBtn.disabled = true;
                    pdLoginBtn.textContent = 'A carregar...';
                    
                    // Seleciona o dropdown
                    pdSegmentSelect.value = savedSegment;
                    
                    const sessionId = await getActiveSessionId();
                    if (!sessionId) {
                        loginError.textContent = 'Nenhuma sessão ativa encontrada. Contate o administrador.';
                        logout();
                        return;
                    }
                    
                    dashboardTitle.textContent = `Painel P&D: ${currentSegment}`;
                    if (currentSegment === 'ADMIN') {
                        adminAccessSection.classList.remove('hidden');
                        renderAccessTable();
                    }
                    
                    await loadAllData(sessionId);
                }
                
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                document.body.innerHTML = '<p class="text-center text-red-500 p-8">Erro crítico ao conectar com o Firebase. Verifique a configuração.</p>';
            }
        })();

    </script>
</body>
</html>




















