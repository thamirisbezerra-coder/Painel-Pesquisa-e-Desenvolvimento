<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de P&D (v2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }

        /* Estilos para o feed de observações e respostas */
        .manager-reply, .seller-reply, .pd-note {
            margin-top: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem; /* rounded-md */
        }
        .manager-reply {
            background-color: #f3f4f6; /* bg-gray-100 */
            border-left: 3px solid #9ca3af; /* border-gray-400 */
        }
        .seller-reply {
            background-color: #f0f9ff; /* bg-blue-50 */
            border-left: 3px solid #60a5fa; /* border-blue-400 */
            margin-left: 1rem; /* Indent seller reply */
        }
         .pd-note {
            background-color: #fffbeb; /* bg-amber-50 */
            border-left: 3px solid #fcd34d; /* border-amber-300 */
            margin-left: 0.5rem;
        }

        /* Estilo para Amostra destacada no modal */
        .feedback-sample-item {
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .feedback-sample-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .feedback-sample-item.highlight {
            background-color: #fffbeb; /* bg-amber-50 */
        }

        /* NOVO: Estilo para os cards de login */
        .login-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background-color: #f9fafb; /* bg-gray-50 */
            border: 1px solid #e5e7eb; /* border-gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* font-semibold */
            color: #374151; /* text-gray-700 */
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .login-card:hover {
            background-color: #f3f4f6; /* bg-gray-100 */
            border-color: #d1d5db; /* border-gray-300 */
        }
        .login-card.selected {
            background-color: #3b82f6; /* bg-blue-600 */
            color: white;
            border-color: #2563eb; /* border-blue-700 */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .login-card-details {
            display: flex;
            align-items: center;
            gap: 0.75rem; /* space-x-3 */
        }
        .login-card-icon {
            flex-shrink: 0;
            width: 2.5rem; /* w-10 */
            height: 2.5rem; /* h-10 */
            border-radius: 9999px; /* rounded-full */
            background-color: #e0e7ff; /* bg-indigo-100 */
            color: #4f46e5; /* text-indigo-600 */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-card.selected .login-card-icon {
            background-color: white;
            color: #3b82f6; /* bg-blue-600 */
        }
        .login-card-name {
            font-size: 0.875rem; /* text-sm */
            color: #6b7280; /* text-gray-500 */
            font-weight: 500; /* font-medium */
        }
        .login-card.selected .login-card-name {
            color: #dbeafe; /* text-blue-100 */
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Tela de Login -->
    <div id="login-view" class="grid place-items-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 w-full max-w-2xl p-8">
            <div class="flex justify-center items-center gap-3 mb-6">
                <div class="p-3 bg-indigo-100 rounded-full">
                    <svg class="w-8 h-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" />
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 text-center">Painel de P&D (v2)</h1>
            </div>
            <p class="text-gray-600 text-center mb-8">Selecione a sua área para aceder ao painel.</p>
            
            <!-- NOVO LAYOUT DE LOGIN (CARDS) -->
            <div id="pd-login-buttons" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Cards de login serão inseridos aqui pelo JS -->
            </div>
            
            <div class="mt-8">
                <input type="password" id="pd-password-input" class="w-full border-gray-300 rounded-lg shadow-sm" placeholder="Digite a sua senha...">
                <button id="pd-login-btn" class="mt-4 w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">Entrar</button>
                <p id="login-error" class="text-red-500 text-sm mt-3 h-4 text-center"></p>
            </div>
        </div>
    </div>

    <!-- Tela Principal (Dashboard) -->
    <div id="dashboard" class="hidden container mx-auto p-4 md:p-8">
        
        <header class="flex flex-col md:flex-row justify-between md:items-center mb-8 gap-4">
            <h1 id="dashboard-title" class="text-3xl font-bold text-gray-900">Dashboard</h1>
            <div class="flex items-center gap-4">
                <input id="global-search-input" type="text" placeholder="Pesquisar em todas as amostras..." class="border-gray-300 rounded-lg shadow-sm text-sm p-2 w-full md:w-64">
                <!-- Sino de Notificação (será adicionado aqui) -->
                <button id="logout-btn" class="bg-red-500 text-white font-semibold py-2 px-5 rounded-lg text-sm hover:bg-red-600">Sair</button>
            </div>
        </header>

        <!-- Estado de Carregamento -->
        <div id="loading-state" class="hidden text-center p-12">
            <h2 class="text-2xl font-semibold text-gray-700">A carregar dados...</h2>
            <p id="loading-message" class="text-gray-500 mt-2">A processar amostras. Isto pode demorar um momento...</p>
        </div>

        <!-- Conteúdo do Dashboard -->
        <div id="dashboard-content" class="hidden">
            <!-- Gráficos -->
            <section class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border">
                    <h3 class="font-bold text-lg mb-2 text-center">Status (Todas Amostras)</h3>
                    <div style="height: 250px;"><canvas id="segment-status-chart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border">
                    <h3 class="font-bold text-lg mb-2 text-center">Distribuição de Feedbacks</h3>
                    <div style="height: 250px;"><canvas id="rejection-rate-chart"></canvas></div>
                </div>
            </section>

            <!-- Feeds Lado a Lado -->
            <section class="grid grid-cols-1 md:grid-cols-2 md:items-start gap-6 mb-10">
                
                <!-- Coluna Feed Observações -->
                <section>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-900">Feed de Observações</h2>
                        <select id="observation-segment-filter" class="border-gray-300 rounded-lg shadow-sm text-sm p-1">
                             <option value="">Todos os Segmentos</option>
                             <!-- Populado por JS -->
                        </select>
                    </div>
                    <div id="observations-feed-list" class="space-y-4 h-[32rem] overflow-y-auto bg-white p-4 rounded-2xl shadow-sm border">
                        <p class="text-gray-500 placeholder-observation">Nenhuma observação encontrada.</p>
                    </div>
                </section>

                <!-- Coluna Post-its P&D -->
                <section>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">Post-its (Notas Internas P&D)</h2>
                    <div class="mb-4">
                        <textarea id="post-it-input" rows="2" class="w-full border-gray-300 rounded-lg shadow-sm" placeholder="Escreva uma nota rápida..."></textarea>
                        <button id="add-post-it-btn" class="mt-2 w-full bg-amber-500 text-white font-semibold py-2 rounded-lg hover:bg-amber-600">Adicionar Post-it</button>
                    </div>
                    <div id="post-it-list" class="space-y-3 h-[24rem] overflow-y-auto bg-gray-50 p-4 rounded-2xl shadow-sm border border-gray-200">
                        <p class="text-gray-500 placeholder-postit">Nenhum post-it encontrado.</p>
                    </div>
                </section>
            </section>

            <!-- Tabela de Acessos (Admin) -->
            <section id="admin-access-section" class="hidden bg-white p-6 rounded-2xl shadow-sm border mb-10">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Acessos P&D (Admin)</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Área / Segmento</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Responsável</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Senha</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="pd-access-tbody" class="bg-white divide-y divide-gray-200">
                            <!-- Linhas inseridas pelo JS -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>

    <!-- Modais -->
    
    <!-- Modal de Amostras por Feedback (Genérico) -->
    <div id="feedback-samples-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-30">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 id="feedback-samples-title" class="text-xl font-bold">Amostras</h3>
                <button id="close-feedback-samples-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="feedback-samples-list" class="space-y-3 max-h-[70vh] overflow-y-auto pr-2">
                <p class="text-gray-500">A carregar detalhes...</p>
            </div>
        </div>
    </div>

    <!-- Modal de Resposta P&D (substitui o 'reply-modal') -->
    <div id="pd-reply-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-xl p-6">
            <h3 class="text-xl font-bold mb-4">Responder ao Vendedor (via P&D)</h3>
            <div class="mb-4 p-3 bg-gray-100 rounded border text-sm">
                <p class="font-semibold" id="pd-reply-modal-product"></p>
                <p class="text-xs text-gray-600 mb-1" id="pd-reply-modal-seller"></p>
                <p class="italic" id="pd-reply-modal-observation">"${' '}"</p>
            </div>
            <div class="space-y-4">
                  <div>
                       <label for="pd-reply-message-input" class="block text-sm font-medium text-gray-700">Sua Resposta (P&D)</label>
                       <textarea id="pd-reply-message-input" rows="3" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm" placeholder="Digite sua resposta aqui..."></textarea>
                  </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                 <button id="cancel-pd-reply-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-5 rounded-lg">Cancelar</button>
                 <button id="send-pd-reply-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Enviar Resposta</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Adicionar Nota Post-it (a partir de uma observação) -->
    <div id="postit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-xl p-6">
            <h3 class="text-xl font-bold mb-4">Adicionar Nota P&D</h3>
            <div class="mb-4 p-3 bg-gray-100 rounded border text-sm">
                <p class="font-semibold" id="postit-modal-context"></p>
                <!-- NOVO: Descrição adicionada -->
                <p class="text-xs text-gray-600" id="postit-modal-description"></p>
                <p class="italic mt-2" id="postit-modal-observation">"${' '}"</p>
            </div>
            <div class="space-y-4">
                  <div>
                       <label for="postit-message-input" class="block text-sm font-medium text-gray-700">Nota Interna P&D</label>
                       <textarea id="postit-message-input" rows="3" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm" placeholder="Digite a nota..."></textarea>
                  </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                 <button id="cancel-postit-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-5 rounded-lg">Cancelar</button>
                 <button id="send-postit-btn" class="bg-amber-500 text-white font-semibold py-2 px-5 rounded-lg">Adicionar Nota</button>
            </div>
        </div>
    </div>

    <!-- Modal de Notificações (Respostas dos Gestores) -->
    <div id="notification-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold">Respostas (Vendedores/Gerentes)</h3>
                <button id="close-notification-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="notification-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <p class="text-gray-500">Nenhuma resposta recebida.</p>
            </div>
        </div>
    </div>

    <!-- Modal de Alerta Customizado -->
    <div id="custom-alert" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
            <h3 id="custom-alert-title" class="text-xl font-bold mb-4 text-red-600">Erro na Operação</h3>
            <p id="custom-alert-message" class="text-gray-700 mb-6">Ocorreu um erro.</p>
            <div class="flex justify-end">
                <button id="custom-alert-ok-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">OK</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot, doc, getDoc, getDocs, 
            updateDoc, query, orderBy, serverTimestamp, addDoc, limit, where,
            collectionGroup, Timestamp, runTransaction, writeBatch, deleteDoc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAF_TE28Tbp2nakBGTva1yEEbBCqWvRdJQ",
            authDomain: "feedback-vendedores.firebaseapp.com",
            projectId: "feedback-vendedores",
            storageBucket: "feedback-vendedores.firebasestorage.app",
            messagingSenderId: "650880422749",
            appId: "1:650880422749:web:54a258964a6ca8db180eb4",
            measurementId: "G-TG588KDK0C"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Definições de Acesso
        const PD_PASSWORDS = {
            'Panificação': { name: 'Adriana', pass: 'pd_adriana5' },
            'Cárneos': { name: 'Anderson', pass: 'pd_anderson3' },
            'Aromas Doces, Salgados e Molhos': { name: 'Carlos', pass: 'pd_carlos1' },
            'Nutracêuticos': { name: 'Daise', pass: 'pd_daise4' },
            'Lácteos': { name: 'Flavia', pass: 'pd_flavia2' },
            'Sorvetes': { name: 'Margarida', pass: 'pd_margarida7' },
            'Nutrição Animal': { name: 'Rebeca', pass: 'pd_rebeca6' },
            'ADMIN': { name: 'Admin', pass: 'admin123' } // Senha de Admin
        };
        const PENDING_STATUSES = ['EM ANÁLISE', 'AMOSTRA SEM FEEDBACK', 'SEM RETORNO DO CLIENTE', 'AMOSTRA NÃO TESTADA', 'PENDENTE'];
        
        // --- Elementos DOM ---
        const loginView = document.getElementById('login-view');
        const pdLoginButtons = document.getElementById('pd-login-buttons');
        const pdPasswordInput = document.getElementById('pd-password-input');
        const pdLoginBtn = document.getElementById('pd-login-btn');
        const loginError = document.getElementById('login-error');
        const dashboard = document.getElementById('dashboard');
        const dashboardTitle = document.getElementById('dashboard-title');
        const logoutBtn = document.getElementById('logout-btn');
        const globalSearchInput = document.getElementById('global-search-input');
        const loadingState = document.getElementById('loading-state');
        const loadingMessage = document.getElementById('loading-message');
        const dashboardContent = document.getElementById('dashboard-content');
        const observationSegmentFilter = document.getElementById('observation-segment-filter');
        const observationsFeedList = document.getElementById('observations-feed-list');
        const postItInput = document.getElementById('post-it-input');
        const addPostItBtn = document.getElementById('add-post-it-btn');
        const postItList = document.getElementById('post-it-list');
        const adminAccessSection = document.getElementById('admin-access-section');
        const pdAccessTbody = document.getElementById('pd-access-tbody');
        const feedbackSamplesModal = document.getElementById('feedback-samples-modal');
        const feedbackSamplesTitle = document.getElementById('feedback-samples-title');
        const feedbackSamplesList = document.getElementById('feedback-samples-list');
        const closeFeedbackSamplesBtn = document.getElementById('close-feedback-samples-btn');
        const pdReplyModal = document.getElementById('pd-reply-modal');
        const pdReplyModalProduct = document.getElementById('pd-reply-modal-product');
        const pdReplyModalSeller = document.getElementById('pd-reply-modal-seller');
        const pdReplyModalObservation = document.getElementById('pd-reply-modal-observation');
        const pdReplyMessageInput = document.getElementById('pd-reply-message-input');
        const cancelPdReplyBtn = document.getElementById('cancel-pd-reply-btn');
        const sendPdReplyBtn = document.getElementById('send-pd-reply-btn');
        const postitModal = document.getElementById('postit-modal');
        const postitModalContext = document.getElementById('postit-modal-context');
        const postitModalDescription = document.getElementById('postit-modal-description'); // NOVO
        const postitModalObservation = document.getElementById('postit-modal-observation');
        const postitMessageInput = document.getElementById('postit-message-input');
        const cancelPostitBtn = document.getElementById('cancel-postit-btn');
        const sendPostitBtn = document.getElementById('send-postit-btn');
        const notificationModal = document.getElementById('notification-modal');
        const notificationList = document.getElementById('notification-list');
        const closeNotificationBtn = document.getElementById('close-notification-btn');
        const notificationBtn = document.getElementById('notification-btn'); // Será criado dinamicamente
        const customAlert = document.getElementById('custom-alert');
        const customAlertTitle = document.getElementById('custom-alert-title');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertOkBtn = document.getElementById('custom-alert-ok-btn');

        // --- Estado Global ---
        let currentSessionId = null;
        let currentSegment = null; // Segmento do P&D logado
        let currentPdName = null; // Nome do P&D logado
        let allCurrentSamples = []; // Armazena TODAS as amostras carregadas
        let sellerSegmentsCache = {}; // Cache de segmentos de vendedores
        let managerRepliesListenerUnsubscribe = null; // Respostas dos gestores
        let sellerRepliesListenerUnsubscribe = null; // Respostas dos vendedores
        let pdPostitsListenerUnsubscribe = null; // Notas internas P&D
        let destaquesListenerUnsubscribe = null; // Amostras destacadas
        let dataListenersUnsubscribe = [];
        let chartInstances = {};
        let currentSampleForReply = null;
        let currentSampleForPostIt = null;
        let allManagerReplies = [];
        let allSellerReplies = [];
        let allPdPostits = [];
        let highlightedSamplesCache = [];
        
        // Classe de Gestão de Carga
        class DataLoadManager {
            constructor(totalItems, onComplete) {
                this.totalItems = totalItems;
                this.loadedItems = 0;
                this.allData = [];
                this.onComplete = onComplete;
                this.hasCompleted = false;
            }

            sellerLoaded(sellerName, samples) {
                this.loadedItems++;
                const samplesWithOwner = samples.map(s => ({ ...s, sellerName }));
                this.allData = this.allData.concat(samplesWithOwner);
                
                const progress = this.totalItems > 0 ? (this.loadedItems / this.totalItems) * 100 : 100;
                loadingMessage.textContent = `A processar... (${this.loadedItems}/${this.totalItems} vendedores carregados)`;

                if (this.loadedItems === this.totalItems && !this.hasCompleted) {
                    this.hasCompleted = true;
                    // O P&D (não-admin) vê TUDO, o filtro é aplicado no feed
                    this.onComplete(this.allData);
                }
            }
        }

        // --- Funções Utilitárias ---
        const normalizeText = (text = '') => text ? text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim() : '';

        function showAlert(message, title = "Erro na Operação", color = "text-red-600") {
            customAlertTitle.textContent = title;
            customAlertMessage.innerHTML = message; // Usar innerHTML para permitir <br>
            customAlertTitle.className = `text-xl font-bold mb-4 ${color}`;
            customAlert.classList.remove('hidden');
        }
        customAlertOkBtn.addEventListener('click', () => customAlert.classList.add('hidden'));

        function handleFirestoreError(error, operationContext) {
            console.error(`Erro em "${operationContext}":`, error);
            let message = `Não foi possível completar a operação: ${operationContext}.<br><br>Erro: ${error.message}`;
            let title = "Erro na Operação";
            let color = "text-red-600";

            if (error.code === 'resource-exhausted' || (error.message && error.message.includes('Quota exceeded'))) {
                message = "O limite diário de uso do banco de dados foi atingido (Quota Exceeded). Novas alterações não serão salvas hoje.<br><br>Por favor, tente novamente amanhã ou contate o suporte.";
                title = "Limite da Plataforma Atingido";
                color = "text-amber-600";
            } else if (error.code === 'permission-denied') {
                message = "Permissão negada. Verifique as regras de segurança do Firebase.";
            }
            // Chama showAlert com todos os argumentos
            showAlert(message, title, color);
        }

        // --- Lógica de Carregamento de Dados (v2) ---

        // CORREÇÃO: Funções movidas para cima para evitar ReferenceError
        
        // Listeners de Comunicação (para o Sino)
        function listenForManagerReplies(sessionId) {
            if (managerRepliesListenerUnsubscribe) managerRepliesListenerUnsubscribe();
            const q = query(collection(db, "sessoes", sessionId, "notificacoesVendedor"));
            
            managerRepliesListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                 allManagerReplies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 renderNotificationBell();
                 if (!dashboardContent.classList.contains('hidden')) {
                     renderObservationsFeed(allCurrentSamples);
                 }
            }, (error) => handleFirestoreError(error, "ouvir respostas dos gestores"));
        }
        
        function listenForSellerReplies(sessionId) {
            if (sellerRepliesListenerUnsubscribe) sellerRepliesListenerUnsubscribe();
            const q = query(collection(db, "sessoes", sessionId, "respostasVendedor"));
            
            sellerRepliesListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                 allSellerReplies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 renderNotificationBell();
                 if (!dashboardContent.classList.contains('hidden')) {
                     renderObservationsFeed(allCurrentSamples);
                 }
            }, (error) => handleFirestoreError(error, "ouvir respostas dos vendedores"));
        }

        // Listener de Post-it
        function listenForPdPostits(sessionId) {
            if (pdPostitsListenerUnsubscribe) pdPostitsListenerUnsubscribe();
            
            // CORREÇÃO: Query deve usar a variável sessionId, não currentSessionId
            const q = query(
                collection(db, "sessoes", sessionId, "pdPostits"),
                orderBy("timestamp", "desc")
            );

            pdPostitsListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                 allPdPostits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 // Re-renderiza o feed
                 if (!dashboardContent.classList.contains('hidden')) {
                     renderPdPostits();
                 }
            }, (error) => {
                 handleFirestoreError(error, "ouvir post-its");
                 allPdPostits = [];
                 if (!dashboardContent.classList.contains('hidden')) {
                     renderPdPostits();
                 }
            });
        }

        // Lógica de Destaque
        function listenForDestaques(sessionId) {
            if (destaquesListenerUnsubscribe) destaquesListenerUnsubscribe();
            
            const destaquesRef = doc(db, "sessoes", sessionId, "configuracoes", "destaquesAmostras");
            
            destaquesListenerUnsubscribe = onSnapshot(destaquesRef, (docSnap) => {
                 highlightedSamplesCache = docSnap.exists() ? (docSnap.data().lista || []) : [];
                 // Re-renderiza o feed
                 if (!dashboardContent.classList.contains('hidden')) {
                     renderObservationsFeed(allCurrentSamples);
                 }
                 // Re-renderiza o modal de amostras (se estiver aberto)
                 if (!feedbackSamplesModal.classList.contains('hidden')) {
                     // Esta função 'showFeedbackSamples' não existe neste painel, vamos usar a de pesquisa
                     // const title = feedbackSamplesTitle.textContent;
                     // openGlobalSearchModal(allCurrentSamples); // Re-mostra com o cache atualizado
                 }
                 
            }, (error) => {
                 handleFirestoreError(error, "ouvir destaques");
            });
        }
        
        async function getActiveSessionId() {
            try {
                const activeSessionRef = doc(db, "configuracoes", "sessaoAtiva");
                const docSnap = await getDoc(activeSessionRef);
                if (docSnap.exists() && docSnap.data().current) {
                    return docSnap.data().current;
                } else {
                    return null;
                }
            } catch (error) {
                handleFirestoreError(error, "buscar sessão ativa");
                return null;
            }
        }

        async function loadSellerSegments() {
            sellerSegmentsCache = {};
            try {
                const segmentsSnap = await getDocs(collection(db, "vendedorConfig"));
                segmentsSnap.forEach(doc => {
                    sellerSegmentsCache[doc.id] = doc.data().segmento;
                });
                console.log("Cache de segmentos carregado:", sellerSegmentsCache);
                
                // Popular o filtro de segmento do feed
                populateSegmentFilter();
                
            } catch (error) {
                handleFirestoreError(error, "carregar segmentos de vendedores");
            }
        }

        async function loadAllData(sessionId) {
            dashboard.classList.remove('hidden');
            loadingState.classList.remove('hidden');
            dashboardContent.classList.add('hidden');
            loginView.classList.add('hidden');
            
            dataListenersUnsubscribe.forEach(unsub => unsub());
            dataListenersUnsubscribe = [];
            
            currentSessionId = sessionId;
            allCurrentSamples = [];

            // 1. Carrega os segmentos primeiro
            await loadSellerSegments();

            // 2. Ouve todas as threads de comunicação e notas
            listenForManagerReplies(sessionId);
            listenForSellerReplies(sessionId);
            listenForPdPostits(sessionId); // <-- CHAMADA CORRIGIDA
            listenForDestaques(sessionId);

            // 3. Busca todos os vendedores da sessão
            const sellersQuery = query(collection(db, "sessoes", sessionId, "vendedores"));
            const sellersSnapshot = await getDocs(sellersQuery);
            const sellerDocs = sellersSnapshot.docs;
            
            if (sellerDocs.length === 0) {
                 console.log("Nenhum vendedor encontrado para esta sessão.");
                 loadingState.classList.add('hidden');
                 dashboardContent.classList.remove('hidden');
                 processAndDisplayDashboard([]);
                 return;
            }

            // 4. Usa o DataLoadManager para carregar as sub-coleções
            const loadManager = new DataLoadManager(sellerDocs.length, (allSamples) => {
                allCurrentSamples = allSamples;
                processAndDisplayDashboard(allCurrentSamples);
                loadingState.classList.add('hidden');
                dashboardContent.classList.remove('hidden');
            });
            
            loadingMessage.textContent = `A preparar para carregar ${sellerDocs.length} vendedores...`;

            // 5. Ouve as 'amostras' de cada vendedor
            sellerDocs.forEach(sellerDoc => {
                const sellerData = sellerDoc.data();
                const samplesQuery = query(
                    collection(db, sellerDoc.ref.path, "amostras")
                );

                const unsub = onSnapshot(samplesQuery, (samplesSnapshot) => {
                    const samples = samplesSnapshot.docs.map(sampleDoc => ({
                        ...sampleDoc.data(),
                        id: sampleDoc.id,
                        sellerDocRef: sellerDoc.ref.path // Guarda a referência do vendedor
                    }));
                    loadManager.sellerLoaded(sellerData.originalName, samples);
                }, (error) => {
                    handleFirestoreError(error, `ouvir amostras de ${sellerData.originalName}`);
                    loadManager.sellerLoaded(sellerData.originalName, []);
                });
                dataListenersUnsubscribe.push(unsub);
            });
        }

        // --- Lógica de Login ---
        
        // NOVO: `populatePdButtons` com cards profissionais
        function populatePdButtons() {
            pdLoginButtons.innerHTML = '';
            // Ícone genérico para P&D
            const iconSvg = `
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="m15.75 15.75-2.489-2.489m0 0a3.375 3.375 0 1 0-4.773-4.773 3.375 3.375 0 0 0 4.774 4.774ZM21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>
            `;

            Object.entries(PD_PASSWORDS).forEach(([segment, data]) => {
                const card = document.createElement('button');
                card.className = "login-card";
                card.dataset.segment = segment;
                
                card.innerHTML = `
                    <div class="login-card-details">
                        <span class="login-card-icon">${iconSvg}</span>
                        <div>
                            <p>${segment}</p>
                            <span class="login-card-name">${data.name}</span>
                        </div>
                    </div>
                    <svg class="w-5 h-5 opacity-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z" clip-rule="evenodd" />
                    </svg>
                `;
                
                card.addEventListener('click', () => {
                    pdLoginButtons.querySelectorAll('.login-card').forEach(c => {
                        c.classList.remove('selected');
                        c.querySelector('svg:last-child').classList.add('opacity-0');
                    });
                    card.classList.add('selected');
                    card.querySelector('svg:last-child').classList.remove('opacity-0');
                    currentSegment = segment;
                    currentPdName = data.name; // Guarda o nome do responsável
                });
                pdLoginButtons.appendChild(card);
            });
        }

        async function login() {
            const password = pdPasswordInput.value;
            if (!currentSegment) {
                loginError.textContent = 'Por favor, selecione a sua área.';
                return;
            }
            
            if (PD_PASSWORDS[currentSegment].pass === password) {
                loginError.textContent = '';
                pdLoginBtn.disabled = true;
                pdLoginBtn.textContent = 'A carregar...';

                // Salva o segmento/nome no localStorage para reconexão (opcional)
                localStorage.setItem('pdSegment', currentSegment); 
                
                const sessionId = await getActiveSessionId();
                if (!sessionId) {
                    loginError.textContent = 'Nenhuma sessão ativa encontrada. Contate o administrador.';
                    pdLoginBtn.disabled = false;
                    pdLoginBtn.textContent = 'Entrar';
                    return;
                }
                
                dashboardTitle.textContent = `Painel P&D: ${currentSegment}`;
                if (currentSegment === 'ADMIN') {
                    adminAccessSection.classList.remove('hidden');
                    renderAccessTable();
                }
                
                await loadAllData(sessionId);

            } else {
                loginError.textContent = 'Senha incorreta.';
            }
        }
        
        function logout() {
            localStorage.removeItem('pdSegment');
            currentSessionId = null;
            currentSegment = null;
            currentPdName = null;
            allCurrentSamples = [];
            allManagerReplies = [];
            allSellerReplies = [];
            allPdPostits = [];
            highlightedSamplesCache = [];
            dataListenersUnsubscribe.forEach(unsub => unsub());
            dataListenersUnsubscribe = [];
            if(managerRepliesListenerUnsubscribe) managerRepliesListenerUnsubscribe();
            if(sellerRepliesListenerUnsubscribe) sellerRepliesListenerUnsubscribe();
            if(pdPostitsListenerUnsubscribe) pdPostitsListenerUnsubscribe();
            if(destaquesListenerUnsubscribe) destaquesListenerUnsubscribe();
            
            dashboard.classList.add('hidden');
            loginView.classList.remove('hidden');
            pdPasswordInput.value = '';
            pdLoginBtn.disabled = false;
            pdLoginBtn.textContent = 'Entrar';
            adminAccessSection.classList.add('hidden');
            pdLoginButtons.querySelectorAll('.login-card').forEach(c => {
                 c.classList.remove('selected');
                 c.querySelector('svg:last-child').classList.add('opacity-0');
            });
            
            // Remove o sino
            document.getElementById('notification-btn')?.parentElement.remove();
        }

        // --- Processamento e Renderização do Dashboard ---
        function processAndDisplayDashboard(samples) {
            if (!samples) return;
            renderCharts(samples);
            renderObservationsFeed(samples);
            renderPdPostits(); // Renderiza os post-its
        }
        
        function populateSegmentFilter() {
            const segments = new Set(Object.values(sellerSegmentsCache).filter(Boolean));
            observationSegmentFilter.innerHTML = '<option value="">Todos os Segmentos</option>';
            Array.from(segments).sort().forEach(segment => {
                const option = document.createElement('option');
                option.value = segment;
                option.textContent = segment;
                observationSegmentFilter.appendChild(option);
            });
        }

        function renderCharts(samples) {
            let pending = 0, resolved = 0, approved = 0, rejected = 0, events = 0;
            const APPROVED_PREFIX = 'A -';
            const REJECTED_PREFIX = 'R -';
            const EVENTS_PREFIX = 'E -';

            samples.forEach(s => {
                if (s.isPending) {
                    pending++;
                } else {
                    resolved++;
                    const feedback = s.feedback || '';
                    if (feedback.startsWith(APPROVED_PREFIX)) approved++;
                    else if (feedback.startsWith(REJECTED_PREFIX)) rejected++;
                    else if (feedback.startsWith(EVENTS_PREFIX)) events++;
                }
            });

            renderChart('segment-status-chart', 'doughnut', {
                labels: ['Pendentes', 'Resolvidos'],
                datasets: [{ data: [pending, resolved], backgroundColor: ['#facc15', '#3b82f6'] }]
            });

            if (approved === 0 && rejected === 0 && events === 0) {
                 renderChart('rejection-rate-chart', 'doughnut', { labels: ['Aguardando Respostas'], datasets: [{ data: [1], backgroundColor: ['#e5e7eb'] }] });
            } else {
                renderChart('rejection-rate-chart', 'doughnut', {
                    labels: ['Aprovadas', 'Reprovadas', 'Eventos'],
                    datasets: [{
                        data: [approved, rejected, events],
                        backgroundColor: ['#34d399', '#f87171', '#a78bfa']
                    }]
                });
            }
        }

        function renderChart(canvasId, type, data, options = {}) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return;
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            
            Chart.register(ChartDataLabels);
            chartInstances[canvasId] = new Chart(ctx, { 
                type, 
                data, 
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: type === 'doughnut' },
                        datalabels: { display: false },
                        ...options.plugins
                    },
                    ...options
                }
            });
        }
        
        // Feed de Observações
        function renderObservationsFeed(samples) {
            const segmentFilter = observationSegmentFilter.value;
            const globalSearch = normalizeText(globalSearchInput.value);
            
            const filteredSamples = samples.filter(s => {
                if (!s.observation) return false;
                
                // Filtro de Segmento
                if (segmentFilter) {
                     const sellerSegment = sellerSegmentsCache[normalizeText(s.sellerName)];
                     if(sellerSegment !== segmentFilter) return false;
                }
                
                // Filtro de Pesquisa Global (se houver)
                if (globalSearch) {
                    return (
                        normalizeText(s.sellerName).includes(globalSearch) ||
                        normalizeText(s.produto).includes(globalSearch) ||
                        normalizeText(s.descricao).includes(globalSearch) ||
                        normalizeText(s.razaoSocial).includes(globalSearch) ||
                        normalizeText(s.observation).includes(globalSearch) ||
                        normalizeText(s.pedido).includes(globalSearch)
                    );
                }
                
                return true; // Passou em tudo
                
            }).sort((a, b) => (b.lastUpdate?.toDate ? b.lastUpdate.toDate().getTime() : 0) - (a.lastUpdate?.toDate ? a.lastUpdate.toDate().getTime() : 0));
            
            observationsFeedList.innerHTML = '';
            if (filteredSamples.length === 0) {
                 const msg = globalSearch ? 'Nenhum resultado para a pesquisa.' : 'Nenhuma observação encontrada.';
                 observationsFeedList.innerHTML = `<p class="text-gray-500 placeholder-observation">${msg}</p>`;
                 return;
            }
            
            filteredSamples.forEach(sample => {
                 const card = document.createElement('div');
                 const isHighlighted = highlightedSamplesCache.includes(sample.id);
                 card.className = `p-4 rounded-lg border ${isHighlighted ? 'bg-amber-50 border-amber-200' : 'bg-white'}`;
                 const time = sample.lastUpdate?.toDate() ? sample.lastUpdate.toDate().toLocaleString('pt-BR') : 'data inválida';
                 
                 // --- Lógica da Thread de Comunicação ---
                 let repliesHtml = '';
                 
                 // 1. Nota P&D (se houver)
                 const pdNote = allPdPostits.find(p => p.contextId === sample.id);
                 if (pdNote) {
                      repliesHtml += `
                         <div class="pd-note">
                             <p><strong>Nota P&D (${pdNote.pdManagerName}):</strong> ${pdNote.message}</p>
                         </div>
                     `;
                 }
                 
                 // 2. Resposta do Gestor
                 const managerReply = allManagerReplies
                    .filter(r => r.sellerName === sample.sellerName && r.pedido === sample.pedido && r.produto === sample.produto && r.originalObservation === sample.observation)
                    .sort((a, b) => (b.timestamp?.toDate() ?? 0) - (a.timestamp?.toDate() ?? 0))[0];
                 
                 if (managerReply) {
                     repliesHtml += `
                         <div class="manager-reply">
                             <p><strong>${managerReply.managerName} (Gerente) respondeu:</strong> ${managerReply.replyMessage}</p>
                         </div>
                     `;
                     
                     // 3. Resposta do Vendedor (a essa resposta)
                     const sellerReply = allSellerReplies
                        .filter(r => r.originalManagerMessage === managerReply.replyMessage && r.pedido === sample.pedido && r.produto === sample.produto)
                        .sort((a, b) => (b.timestamp?.toDate() ?? 0) - (a.timestamp?.toDate() ?? 0))[0];
                     
                     if (sellerReply) {
                         repliesHtml += `
                             <div class="seller-reply">
                                 <p><strong>${sellerReply.sellerName} (Vendedor) respondeu:</strong> ${sellerReply.replyMessage}</p>
                             </div>
                         `;
                     }
                 }
                 // --- Fim da Lógica da Thread ---
                 
                 // Ícone de Destaque (Estrela)
                 const starIcon = isHighlighted ?
                     `<svg class="w-5 h-5 text-amber-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588 1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>` :
                     `<svg class="w-5 h-5 text-gray-400 hover:text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.524 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.524 4.674c.3.921-.755 1.688-1.54 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.784.57-1.838-.197-1.539-1.118l1.524-4.674a1 1 0 00-.363-1.118L2.98 10.1c-.783-.57-.38-1.81.588 1.81h4.914a1 1 0 00.951-.69l1.524-4.674z"></path></svg>`;

                 card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="mb-2">
                            <p class="font-bold text-gray-800">${sample.produto}</p>
                            <!-- NOVO: Descrição adicionada -->
                            <p class="text-sm text-gray-600">${sample.descricao || 'Sem descrição'}</p>
                            <p class="text-xs text-gray-500">${sample.razaoSocial || 'Cliente N/A'}</p>
                        </div>
                        <button class="highlight-sample-btn p-1 rounded-full hover:bg-gray-100" data-sample-id="${sample.id}" title="Destacar Amostra">
                            ${starIcon}
                        </button>
                    </div>
                    <p class="text-gray-700 mb-3 italic">"${sample.observation}"</p>
                    
                    ${repliesHtml}

                    <div class="flex justify-between items-end text-xs text-gray-500 mt-3 pt-3 border-t">
                         <div>
                             <p>- ${sample.sellerName} (Pedido: ${sample.pedido})</p>
                             <!-- NOVO: Data Faturamento adicionada -->
                             <p class="text-gray-400">Fat.: ${sample.emissaoNF || 'N/A'} | Obs.: ${time}</p>
                         </div>
                         <div class="flex gap-2">
                             <button class="add-postit-modal-btn bg-amber-100 text-amber-800 hover:bg-amber-200 px-2 py-1 rounded text-xs font-semibold" data-sample-id="${sample.id}">
                                 ${pdNote ? 'Editar Nota' : 'Adicionar Nota'}
                             </button>
                             <button class="pd-reply-btn bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded text-xs font-semibold" data-sample-id="${sample.id}">
                                 Responder
                             </button>
                         </div>
                    </div>
                 `;
                 observationsFeedList.appendChild(card);
            });
            
            // Listeners
            observationsFeedList.querySelectorAll('.pd-reply-btn').forEach(btn => {
                 btn.addEventListener('click', openPdReplyModal);
            });
            observationsFeedList.querySelectorAll('.add-postit-modal-btn').forEach(btn => {
                 btn.addEventListener('click', openPostItModal);
            });
            observationsFeedList.querySelectorAll('.highlight-sample-btn').forEach(btn => {
                 btn.addEventListener('click', toggleDestaqueAmostra);
            });
        }
        
        // Feed de Post-its
        function renderPdPostits() {
            const globalSearch = normalizeText(globalSearchInput.value);
            
            const filteredNotes = allPdPostits.filter(note => {
                if (globalSearch) {
                     return (
                         normalizeText(note.message).includes(globalSearch) ||
                         normalizeText(note.context).includes(globalSearch) ||
                         normalizeText(note.pedido).includes(globalSearch) ||
                         normalizeText(note.pdManagerName).includes(globalSearch)
                     );
                }
                return true;
            }).sort((a, b) => (b.timestamp?.toDate() ?? 0) - (a.timestamp?.toDate() ?? 0));
            
            postItList.innerHTML = '';
            if (filteredNotes.length === 0) {
                 const msg = globalSearch ? 'Nenhum post-it encontrado na pesquisa.' : 'Nenhum post-it encontrado.';
                 postItList.innerHTML = `<p class="text-gray-500 placeholder-postit">${msg}</p>`;
                 return;
            }
            
            filteredNotes.forEach(note => {
                const card = document.createElement('div');
                card.className = "p-3 rounded-lg bg-amber-50 border border-amber-200 shadow-sm";
                const time = note.timestamp?.toDate() ? note.timestamp.toDate().toLocaleString('pt-BR') : '';

                card.innerHTML = `
                    <p class="text-sm text-gray-800">${note.message}</p>
                    <div class="mt-2 pt-2 border-t border-amber-200">
                        <!-- Contexto (Vendedor/Produto) -->
                        <p class="text-xs text-gray-600">${note.context || 'Nota geral'}</p>
                        <!-- Pedido e Faturamento (se houver) -->
                        ${note.pedido ? `<p class="text-xs text-gray-500">Pedido: ${note.pedido} | Fat.: ${note.dataFaturamento || 'N/A'}</p>` : ''}
                    </div>
                    <div class="flex justify-between items-center mt-2 text-xs">
                        <span class="font-semibold text-amber-800">${note.pdManagerName}</span>
                        <div>
                            <button class="delete-post-it-btn text-gray-400 hover:text-red-500 font-medium" data-note-id="${note.id}">Excluir</button>
                            <span class="text-gray-400 ml-2">${time}</span>
                        </div>
                    </div>
                `;
                postItList.appendChild(card);
            });
        }
        
        function renderAccessTable() {
             pdAccessTbody.innerHTML = '';
             Object.entries(PD_PASSWORDS).forEach(([segment, data]) => {
                 if(segment === 'ADMIN') return;
                 const row = document.createElement('tr');
                 row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${segment}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 password-cell" data-password="${data.pass}">••••••</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="toggle-password-btn text-blue-600 hover:text-blue-800" data-state="hidden">Visualizar</button>
                    </td>
                 `;
                 pdAccessTbody.appendChild(row);
             });
        }

        // --- Lógica de Resposta e Notificação ---
        
        function openPdReplyModal(e) {
             const sampleId = e.currentTarget.dataset.sampleId;
             currentSampleForReply = allCurrentSamples.find(s => s.id === sampleId);
             if (!currentSampleForReply) return showAlert("Erro: Amostra não encontrada.");
             
             pdReplyModalProduct.textContent = `${currentSampleForReply.produto} (${currentSampleForReply.pedido})`;
             pdReplyModalSeller.textContent = `Observação de: ${currentSampleForReply.sellerName}`;
             pdReplyModalObservation.textContent = `"${currentSampleForReply.observation}"`;
             pdReplyMessageInput.value = '';
             pdReplyModal.classList.remove('hidden');
        }

        async function sendReplyToPd() {
            if (!currentSampleForReply || !currentSessionId) return;
            
            const replyMessage = pdReplyMessageInput.value.trim();
            if (!replyMessage || !currentPdName) {
                return showAlert("A mensagem de resposta não pode estar vazia.");
            }

            sendPdReplyBtn.disabled = true;
            sendPdReplyBtn.textContent = 'A Enviar...';

            try {
                // P&D usa a mesma coleção 'notificacoesVendedor', mas com nome P&D
                const notificationData = {
                    managerName: `P&D (${currentPdName})`, // Identifica como P&D
                    replyMessage: replyMessage,
                    originalObservation: currentSampleForReply.observation,
                    sellerName: currentSampleForReply.sellerName,
                    pedido: currentSampleForReply.pedido,
                    produto: currentSampleForReply.produto,
                    razaoSocial: currentSampleForReply.razaoSocial || '',
                    descricao: currentSampleForReply.descricao || '',
                    timestamp: serverTimestamp(),
                    read: false,
                    readByPd: false // NOVO: Flag para P&D
                };

                const sellerNotifsRef = collection(db, "sessoes", currentSessionId, "notificacoesVendedor");
                await addDoc(sellerNotifsRef, notificationData);

                pdReplyModal.classList.add('hidden');
                showAlert("Resposta enviada com sucesso.", "Sucesso", "text-green-600");
                
            } catch (error) {
                handleFirestoreError(error, "enviar resposta P&D");
            } finally {
                sendPdReplyBtn.disabled = false;
                sendPdReplyBtn.textContent = 'Enviar Resposta';
                currentSampleForReply = null;
            }
        }
        
        // --- Lógica de Post-it ---
        
        function openPostItModal(e) {
             const sampleId = e.currentTarget.dataset.sampleId;
             currentSampleForPostIt = allCurrentSamples.find(s => s.id === sampleId);
             if (!currentSampleForPostIt) return showAlert("Erro: Amostra não encontrada.");
             
             const existingNote = allPdPostits.find(p => p.contextId === sampleId);
             
             postitModalContext.textContent = `Ref: ${currentSampleForPostIt.produto} (Vendedor: ${currentSampleForPostIt.sellerName})`;
             // NOVO: Adiciona descrição
             postitModalDescription.textContent = `${currentSampleForPostIt.descricao || 'Sem descrição'}`;
             postitModalObservation.textContent = `"${currentSampleForPostIt.observation}"`;
             postitMessageInput.value = existingNote ? existingNote.message : '';
             sendPostitBtn.textContent = existingNote ? 'Atualizar Nota' : 'Adicionar Nota';
             
             postitModal.classList.remove('hidden');
        }
        
        async function sendPostIt() {
             if (!currentSampleForPostIt || !currentSessionId) return;
             
             const message = postitMessageInput.value.trim();
             if (!message || !currentPdName) {
                 return showAlert("A nota não pode estar vazia.");
             }
             
             sendPostitBtn.disabled = true;
             
             try {
                 const existingNote = allPdPostits.find(p => p.contextId === currentSampleForPostIt.id);
                 
                 const noteData = {
                     pdManagerName: currentPdName,
                     message: message,
                     context: `Amostra: ${currentSampleForPostIt.produto} (Vendedor: ${currentSampleForPostIt.sellerName})`,
                     contextId: currentSampleForPostIt.id,
                     pedido: currentSampleForPostIt.pedido || '',
                     dataFaturamento: currentSampleForPostIt.emissaoNF || '',
                     timestamp: serverTimestamp(),
                 };
                 
                 if (existingNote) {
                     // Atualiza a nota existente
                     const noteRef = doc(db, "sessoes", currentSessionId, "pdPostits", existingNote.id);
                     await updateDoc(noteRef, noteData);
                 } else {
                     // Adiciona uma nova nota
                     const postitsRef = collection(db, "sessoes", currentSessionId, "pdPostits");
                     await addDoc(postitsRef, noteData);
                 }
                 
                 postitModal.classList.add('hidden');
                 
             } catch (error) {
                 handleFirestoreError(error, "salvar post-it");
             } finally {
                 sendPostitBtn.disabled = false;
                 currentSampleForPostIt = null;
             }
        }
        
        async function addPostItFromInput() {
             const message = postItInput.value.trim();
             if (!message || !currentPdName) return;
             
             addPostItBtn.disabled = true;
             
             try {
                 const noteData = {
                     pdManagerName: currentPdName,
                     message: message,
                     context: "Nota Geral (sem amostra vinculada)",
                     contextId: null,
                     pedido: null,
                     dataFaturamento: null,
                     timestamp: serverTimestamp(),
                 };
                 const postitsRef = collection(db, "sessoes", currentSessionId, "pdPostits");
                 await addDoc(postitsRef, noteData);
                 postItInput.value = ''; // Limpa o input
                 
             } catch (error) {
                 handleFirestoreError(error, "adicionar post-it geral");
             } finally {
                 addPostItBtn.disabled = false;
             }
        }
        
        async function deletePostIt(e) {
             const noteId = e.currentTarget.dataset.noteId;
             if (!noteId || !currentSessionId) return;
             
             // Adicionar confirmação
             if (!confirm("Tem certeza que quer excluir esta nota?")) return;
             
             e.currentTarget.disabled = true;
             
             try {
                 const noteRef = doc(db, "sessoes", currentSessionId, "pdPostits", noteId);
                 await deleteDoc(noteRef);
             } catch (error) {
                 handleFirestoreError(error, "excluir post-it");
                 e.currentTarget.disabled = false;
             }
             // O listener cuidará da remoção da UI
        }
        
        // --- Lógica de Destaque ---
        
        async function toggleDestaqueAmostra(e) {
            e.stopPropagation();
            const sampleId = e.currentTarget.dataset.sampleId;
            if (!currentSessionId || !sampleId) return;

            const destaquesRef = doc(db, "sessoes", currentSessionId, "configuracoes", "destaquesAmostras");
            const button = e.currentTarget;
            button.disabled = true;

            try {
                await runTransaction(db, async (transaction) => {
                    const destaquesDoc = await transaction.get(destaquesRef);
                    const currentList = destaquesDoc.exists() ? (destaquesDoc.data().lista || []) : [];
                    
                    if (currentList.includes(sampleId)) {
                        const updatedList = currentList.filter(id => id !== sampleId);
                        transaction.set(destaquesRef, { lista: updatedList });
                    } else {
                        const updatedList = [...currentList, sampleId];
                        transaction.set(destaquesRef, { lista: updatedList });
                    }
                });
            } catch (error) {
                handleFirestoreError(error, "atualizar destaques");
            } finally {
                button.disabled = false; // O listener vai atualizar a UI
            }
        }
        
        // Sino de Notificação (mostra respostas de Gerentes E Vendedores)
        function renderNotificationBell() {
             // O P&D só quer saber de respostas NÃO LIDAS
             const unreadManagerReplies = allManagerReplies.filter(r => !r.readByPd);
             const unreadSellerReplies = allSellerReplies.filter(r => !r.readByManager); // P&D usa a mesma flag
             
             const unreadCount = unreadManagerReplies.length + unreadSellerReplies.length;
             
             let bellBtn = document.getElementById('notification-btn');
             let countBadge = document.getElementById('notification-count-badge');
             
             if (!bellBtn) {
                const header = document.querySelector('#dashboard header .flex.items-center.gap-4');
                const bellWrapper = document.createElement('div');
                bellWrapper.className = "relative";
                bellWrapper.innerHTML = `
                    <button id="notification-btn" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                        <span id="notification-count-badge" class="hidden absolute top-0 right-0 -mt-1 -mr-1 px-2 py-0.5 bg-red-500 text-white text-xs rounded-full">0</span>
                    </button>
                `;
                header.insertBefore(bellWrapper, logoutBtn);
                bellBtn = document.getElementById('notification-btn');
                countBadge = document.getElementById('notification-count-badge');
             }
             
             // Atualiza o listener com as respostas mais recentes
             bellBtn.onclick = () => openNotificationModal(unreadManagerReplies, unreadSellerReplies);
             
             if (unreadCount > 0) {
                 countBadge.textContent = unreadCount;
                 countBadge.classList.remove('hidden');
             } else {
                 countBadge.classList.add('hidden');
             }
        }
        
        function openNotificationModal(managerReplies, sellerReplies) {
             notificationList.innerHTML = '';
             
             if (managerReplies.length === 0 && sellerReplies.length === 0) {
                 notificationList.innerHTML = '<p class="text-gray-500">Nenhuma resposta nova.</p>';
                 notificationModal.classList.remove('hidden');
                 return;
             }
             
             // Junta, ordena por data
             const allReplies = [
                 ...managerReplies.map(r => ({ ...r, type: 'manager', ref: doc(db, "sessoes", currentSessionId, "notificacoesVendedor", r.id) })),
                 ...sellerReplies.map(r => ({ ...r, type: 'seller', ref: doc(db, "sessoes", currentSessionId, "respostasVendedor", r.id) }))
             ].sort((a,b) => (b.timestamp?.toDate() ?? 0) - (a.timestamp?.toDate() ?? 0));
             
             allReplies.forEach(reply => {
                 const item = document.createElement('div');
                 item.className = "p-3 border-b border-gray-100";
                 
                 if (reply.type === 'manager') {
                     item.innerHTML = `
                        <p><span class="font-semibold text-blue-600">${reply.managerName}</span> (Gerente) respondeu:</p>
                        <p class="italic text-gray-700 my-1">"${reply.replyMessage}"</p>
                        <p class="text-xs text-gray-500">Ref: ${reply.produto} (Vendedor: ${reply.sellerName})</p>
                        <div class="text-right mt-2">
                            <button class="mark-as-read-btn bg-gray-200 text-gray-700 text-xs font-semibold py-1 px-3 rounded hover:bg-gray-300" data-type="manager" data-id="${reply.id}">Marcar como Lida</button>
                        </div>
                     `;
                 } else { // type === 'seller'
                      item.innerHTML = `
                        <p><span class="font-semibold text-green-600">${reply.sellerName}</span> (Vendedor) respondeu:</p>
                        <p class="italic text-gray-700 my-1">"${reply.replyMessage}"</p>
                        <p class="text-xs text-gray-500">Ref: ${reply.produto} (Pedido: ${reply.pedido})</p>
                        <p class="text-xs text-gray-400">Mensagem original: "${reply.originalManagerMessage}"</p>
                        <div class="text-right mt-2">
                            <button class="mark-as-read-btn bg-gray-200 text-gray-700 text-xs font-semibold py-1 px-3 rounded hover:bg-gray-300" data-type="seller" data-id="${reply.id}">Marcar como Lida</button>
                        </div>
                     `;
                 }
                 notificationList.appendChild(item);
             });
             
             notificationModal.classList.remove('hidden');
        }
        
        async function markReplyAsRead(e) {
             const button = e.target;
             const replyId = button.dataset.id;
             const type = button.dataset.type;
             button.disabled = true;
             
             try {
                 let replyRef;
                 let fieldToUpdate;
                 
                 if (type === 'manager') {
                     replyRef = doc(db, "sessoes", currentSessionId, "notificacoesVendedor", replyId);
                     fieldToUpdate = { readByPd: true };
                 } else { // seller
                     replyRef = doc(db, "sessoes", currentSessionId, "respostasVendedor", replyId);
                     fieldToUpdate = { readByManager: true };
                 }
                 
                 await updateDoc(replyRef, fieldToUpdate);
                 // O listener vai atualizar o sino
                 
             } catch (error) {
                 handleFirestoreError(error, "marcar resposta como lida");
                 button.disabled = false;
             }
        }
        
        // --- Modal de Amostras (Pesquisa Global) ---
        
        function openGlobalSearchModal(samples) {
            feedbackSamplesTitle.textContent = `Resultados da Pesquisa: "${globalSearchInput.value}" (${samples.length})`;
            feedbackSamplesList.innerHTML = '';
            
            if (samples.length === 0) {
                 feedbackSamplesList.innerHTML = '<p class="text-gray-500">Nenhum resultado encontrado.</p>';
                 feedbackSamplesModal.classList.remove('hidden');
                 return;
            }
            
            samples.forEach(sample => {
                 const itemDiv = document.createElement('div');
                 const isHighlighted = highlightedSamplesCache.includes(sample.id);
                 itemDiv.className = `feedback-sample-item text-sm ${isHighlighted ? 'highlight' : ''}`;
                 
                 // Construir a thread de comunicação (igual ao feed)
                 let repliesHtml = '';
                 const pdNote = allPdPostits.find(p => p.contextId === sample.id);
                 if (pdNote) repliesHtml += `<div class="pd-note"><p><strong>Nota P&D:</strong> ${pdNote.message}</p></div>`;
                 const managerReply = allManagerReplies.find(r => r.sellerName === sample.sellerName && r.pedido === sample.pedido && r.produto === sample.produto && r.originalObservation === sample.observation);
                 if (managerReply) {
                     repliesHtml += `<div class="manager-reply"><p><strong>${managerReply.managerName}:</strong> ${managerReply.replyMessage}</p></div>`;
                     const sellerReply = allSellerReplies.find(r => r.originalManagerMessage === managerReply.replyMessage && r.pedido === sample.pedido);
                     if (sellerReply) repliesHtml += `<div class="seller-reply"><p><strong>${sellerReply.sellerName}:</strong> ${sellerReply.replyMessage}</p></div>`;
                 }
                 
                 const starIcon = isHighlighted ?
                     `<svg class="w-5 h-5 text-amber-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588 1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>` :
                     `<svg class="w-5 h-5 text-gray-400 hover:text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.524 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.524 4.674c.3.921-.755 1.688-1.54 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.784.57-1.838-.197-1.539-1.118l1.524-4.674a1 1 0 00-.363-1.118L2.98 10.1c-.783-.57-.38-1.81.588 1.81h4.914a1 1 0 00.951-.69l1.524-4.674z"></path></svg>`;

                 itemDiv.innerHTML = `
                     <div class="flex justify-between items-start">
                         <div>
                             <p class="font-semibold">${sample.produto} (${sample.razaoSocial})</p>
                             <p class="text-xs text-gray-600">${sample.descricao}</p>
                             <p class="text-xs text-gray-500 mt-1">
                                 Vendedor: ${sample.sellerName} | Pedido: ${sample.pedido} | NF: ${sample.emissaoNF || 'N/A'}
                             </p>
                             <p class="font-medium text-gray-800 mt-1">Feedback: ${sample.feedback || 'Pendente'}</p>
                         </div>
                         <button class="highlight-sample-btn p-1 rounded-full hover:bg-gray-100" data-sample-id="${sample.id}">
                             ${starIcon}
                         </button>
                     </div>
                     ${sample.observation ? `<p class="text-xs text-gray-600 mt-1 italic">Obs: ${sample.observation}</p>` : ''}
                     ${repliesHtml}
                 `;
                 feedbackSamplesList.appendChild(itemDiv);
            });
            
            // Listeners
            feedbackSamplesList.querySelectorAll('.highlight-sample-btn').forEach(btn => {
                 btn.addEventListener('click', toggleDestaqueAmostra);
            });
            
            feedbackSamplesModal.classList.remove('hidden');
        }


        // --- Event Listeners Globais ---
        pdLoginBtn.addEventListener('click', login);
        logoutBtn.addEventListener('click', logout);
        observationSegmentFilter.addEventListener('change', () => renderObservationsFeed(allCurrentSamples));
        
        globalSearchInput.addEventListener('keyup', (e) => {
            // Se pressionar Enter, abre o modal de pesquisa
            if (e.key === 'Enter') {
                const searchTerm = normalizeText(globalSearchInput.value);
                if (!searchTerm) {
                    renderObservationsFeed(allCurrentSamples);
                    renderPdPostits();
                    return;
                }
                // Filtra as amostras (não apenas as com observação)
                const filteredSamples = allCurrentSamples.filter(s => 
                    normalizeText(s.sellerName).includes(searchTerm) ||
                    normalizeText(s.produto).includes(searchTerm) ||
                    normalizeText(s.descricao).includes(searchTerm) ||
                    normalizeText(s.razaoSocial).includes(searchTerm) ||
                    (s.observation && normalizeText(s.observation).includes(searchTerm)) ||
                    normalizeText(s.pedido).includes(searchTerm)
                ).sort((a, b) => (b.lastUpdate?.toDate ? b.lastUpdate.toDate().getTime() : 0) - (a.lastUpdate?.toDate ? a.lastUpdate.toDate().getTime() : 0));
                
                openGlobalSearchModal(filteredSamples);
                
            } else { // Pesquisa em tempo real nos feeds
                renderObservationsFeed(allCurrentSamples);
                renderPdPostits();
            }
        });

        // Modais
        closeFeedbackSamplesBtn.addEventListener('click', () => feedbackSamplesModal.classList.add('hidden'));
        cancelPdReplyBtn.addEventListener('click', () => pdReplyModal.classList.add('hidden'));
        sendPdReplyBtn.addEventListener('click', sendReplyToPd);
        cancelPostitBtn.addEventListener('click', () => postitModal.classList.add('hidden'));
        sendPostitBtn.addEventListener('click', sendPostIt);
        
        // Caixa de Post-it principal
        addPostItBtn.addEventListener('click', addPostItFromInput);
        postItList.addEventListener('click', (e) => {
             const button = e.target.closest('.delete-post-it-btn');
             if (button) deletePostIt({ currentTarget: button });
        });

        // Modal de Notificações (Respostas dos Gestores/Vendedores)
        closeNotificationBtn.addEventListener('click', () => notificationModal.classList.add('hidden'));
        notificationList.addEventListener('click', (e) => {
            const button = e.target.closest('.mark-as-read-btn');
            if (button) markReplyAsRead({ target: button });
        });
        
        // Tabela de Acessos (Admin)
        pdAccessTbody.addEventListener('click', (e) => {
            const button = e.target.closest('.toggle-password-btn');
            if (button) {
                const cell = button.closest('tr').querySelector('.password-cell');
                const password = cell.dataset.password;
                if (button.dataset.state === 'hidden') {
                    cell.textContent = password;
                    button.textContent = 'Ocultar';
                    button.dataset.state = 'visible';
                } else {
                    cell.textContent = '••••••';
                    button.textContent = 'Visualizar';
                    button.dataset.state = 'hidden';
                }
            }
        });

        // --- INICIALIZAÇÃO ---
        (async () => {
            try {
                await signInAnonymously(auth);
                populatePdButtons();
                
                // Tenta fazer login automático se já esteve logado
                const savedSegment = localStorage.getItem('pdSegment');
                if (savedSegment && PD_PASSWORDS[savedSegment]) {
                    currentSegment = savedSegment;
                    currentPdName = PD_PASSWORDS[savedSegment].name;
                    pdLoginBtn.disabled = true;
                    pdLoginBtn.textContent = 'A carregar...';
                    
                    const sessionId = await getActiveSessionId();
                    if (!sessionId) {
                        loginError.textContent = 'Nenhuma sessão ativa encontrada. Contate o administrador.';
                        logout();
                        return;
                    }
                    
                    dashboardTitle.textContent = `Painel P&D: ${currentSegment}`;
                    if (currentSegment === 'ADMIN') {
                        adminAccessSection.classList.remove('hidden');
                        renderAccessTable();
                    }
                    
                    await loadAllData(sessionId);
                }
                
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                document.body.innerHTML = '<p class="text-center text-red-500 p-8">Erro crítico ao conectar com o Firebase. Verifique a configuração.</p>';
            }
        })();

    </script>
</body>
</html>













